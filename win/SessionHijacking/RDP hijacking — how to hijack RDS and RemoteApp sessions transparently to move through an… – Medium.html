<!DOCTYPE html><html xmlns:cc="http://creativecommons.org/ns#"><head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# medium-com: http://ogp.me/ns/fb/medium-com#"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…</title><link rel="canonical" href="https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6"><meta name="title" content="RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…"><meta name="referrer" content="always"><meta name="description" content="If you’ve used Remote Desktop Services before, or Terminal Services if you’re as old as me, you will know there’s a feature where you connect to another user’s session — if you know their password…"><meta property="og:title" content="RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…"><meta property="og:url" content="https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6"><meta property="og:image" content="https://cdn-images-1.medium.com/max/1200/1*bd6ZhReKUzjJwunNpA6cDg.gif"><meta property="fb:app_id" content="542599432471018"><meta property="og:description" content="How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to…"><meta name="twitter:description" content="How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to…"><meta name="twitter:image:src" content="https://cdn-images-1.medium.com/max/1200/1*bd6ZhReKUzjJwunNpA6cDg.gif"><link rel="publisher" href="https://plus.google.com/103654360130207659246"><link rel="author" href="https://medium.com/@networksecurity"><meta property="author" content="Kevin Beaumont"><meta property="og:type" content="article"><meta name="twitter:card" content="summary_large_image"><meta property="article:publisher" content="https://www.facebook.com/medium"><meta property="article:author" content="https://medium.com/@networksecurity"><meta property="fb:smart_publish:robots" content="noauto"><meta name="robots" content="index, follow"><meta property="article:published_time" content="2017-03-19T23:55:46.180Z"><meta name="twitter:site" content="@Medium"><meta property="og:site_name" content="Medium"><meta name="twitter:label1" value="Reading time"><meta name="twitter:data1" value="7 min read"><script type="application/ld+json">{"@context":"http://schema.org","@type":"NewsArticle","image":{"@type":"ImageObject","width":480,"height":274,"url":"https://cdn-images-1.medium.com/max/480/1*bd6ZhReKUzjJwunNpA6cDg.gif"},"datePublished":"2017-03-19T23:55:46.180Z","dateModified":"2017-03-20T20:41:45.452Z","headline":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…","name":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…","keywords":["Microsoft","Sysadmin","Rds","Hijack"],"author":{"@type":"Person","name":"Kevin Beaumont","url":"https://medium.com/@networksecurity"},"creator":["Kevin Beaumont"],"mainEntityOfPage":"https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6"}</script><meta name="twitter:app:name:iphone" content="Medium"><meta name="twitter:app:id:iphone" content="828256236"><meta name="twitter:app:url:iphone" content="medium://p/da2a1e73a5f6"><meta property="al:ios:app_name" content="Medium"><meta property="al:ios:app_store_id" content="828256236"><meta property="al:android:package" content="com.medium.reader"><meta property="al:android:app_name" content="Medium"><meta property="al:ios:url" content="medium://p/da2a1e73a5f6"><meta property="al:android:url" content="medium://p/da2a1e73a5f6"><meta property="al:web:url" content="https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6"><link rel="search" type="application/opensearchdescription+xml" title="Medium" href="/osd.xml" /><link rel="alternate" href="android-app://com.medium.reader/https/medium.com/p/da2a1e73a5f6" /><meta name="theme-color" content="#000000"><link rel="stylesheet" type="text/css" href="https://cdn-static-1.medium.com/_/fp/css/fonts-latin-base.141WxxXgxGxNcfeza73H7Q.css" /><link rel="stylesheet" href="https://cdn-static-1.medium.com/_/fp/css/main-base.fzwQRr7WdD2vETluRWIK9g.css"><script>if (window.top !== window.self) window.top.location = window.self.location.href;var OB_startTime = new Date().getTime(); var OB_loadErrors = []; function _onerror(e) { OB_loadErrors.push(e) }; if (document.addEventListener) document.addEventListener("error", _onerror, true); else if (document.attachEvent) document.attachEvent("onerror", _onerror); function _asyncScript(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("script"); s.type = "text/javascript"; s.async = true; s.src = u; f.parentNode.insertBefore(s, f);}function _asyncStyles(u) {var d = document, f = d.getElementsByTagName("script")[0], s = d.createElement("link"); s.rel = "stylesheet"; s.href = u; f.parentNode.insertBefore(s, f); return s}(new Image()).src = "/_/stat?event=pixel.load&origin=" + encodeURIComponent(location.origin);</script><!--[if lt IE 9]><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js"></script><![endif]--><link rel="icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico" class="js-favicon"><link rel="apple-touch-icon" sizes="152x152" href="https://cdn-images-1.medium.com/fit/c/152/152/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="120x120" href="https://cdn-images-1.medium.com/fit/c/120/120/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="76x76" href="https://cdn-images-1.medium.com/fit/c/76/76/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="apple-touch-icon" sizes="60x60" href="https://cdn-images-1.medium.com/fit/c/60/60/1*W0nmth_X8nFKjn6BZ388UQ.png"><link rel="mask-icon" href="https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg" color="#171717"></head><body itemscope class=" postShowScreen browser-chrome is-withMagicUnderlines is-noJs"><script>document.body.className = document.body.className.replace(/(^|\s)is-noJs(\s|$)/, "$1is-js$2")</script><div class="site-main" id="container"><div class="butterBar butterBar--error"></div><div class="surface"><div id="prerendered" class="screenContent"><canvas class="canvas-renderer"></canvas><div class="container u-maxWidth740 u-xs-margin0 notesPositionContainer js-notesPositionContainer"></div><div class="metabar u-clearfix js-metabar"><div class="metabar-inner u-marginAuto u-maxWidth1000 u-paddingLeft20 u-paddingRight20 js-metabarMiddle"><div class="metabar-block metabar-block--left u-floatLeft u-height65 u-xs-height56"><a href="https://medium.com/" class="siteNav-logo" data-log-event="home"><span class="svgIcon svgIcon--logoNew svgIcon--45px is-flushLeft"><svg class="svgIcon-use" width="45" height="45"  viewBox="-17 18 45 45" data-multipart="true"><path d="M11.525 28.078c-.472-.225-.858.002-.858.506v20.044l8.616 4.113c.948.46 1.717.14 1.717-.7v-19.3a.22.22 0 0 0-.124-.19l-9.35-4.46v-.01z"/><path d="M.333 43.696l9.83-15.247c.278-.43.89-.6 1.36-.38l9.364 4.47c.06.03.082.1.047.15L10.666 48.63.333 43.698v-.002z"/><path d="M-8.57 28.35c-.786-.375-1.053-.096-.592.62L.333 43.696l10.333 4.932L.356 32.635a.156.156 0 0 0-.06-.054l-8.866-4.23z"/><path d="M.333 52.033c0 .84-.643 1.22-1.43.844l-8.045-3.84c-.472-.224-.858-.82-.858-1.325V28.89c0-.672.515-.976 1.145-.675l9.133 4.36a.092.092 0 0 1 .055.084v19.37z"/></svg></span><span class="u-textScreenReader">Homepage</span></a></div><div class="metabar-block u-floatRight u-xs-absolute u-xs-textAlignRight u-xs-right0 u-xs-marginRight20 u-height65 u-xs-height56"><div class="buttonSet"><a class="button button--primary button--chromeless u-accentColor--buttonNormal is-inSiteNavBar u-lineHeight30 u-height32"  href="https://medium.com/m/signin?redirect=https%3A%2F%2Fmedium.com%2F%40networksecurity%2Frdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6" data-action="sign-in-prompt" data-redirect="https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6" data-action-source="nav_signup">Sign in / Sign up</a></div></div></div></div><div class="metabar metabar--spacer js-metabarSpacer u-height65 u-xs-height56"></div><main role="main"><article class=" u-sizeViewHeightMin100 u-overflowHidden postArticle postArticle--full u-marginBottom40"  lang="en"><header class="container u-maxWidth740"><div class="postMetaHeader u-paddingBottom10 row"><div class="col u-size12of12 js-postMetaLockup"><div class="postMetaLockup postMetaLockup--authorWithBio u-flex js-postMetaLockup"><div class="u-flex0"><a class="link avatar u-baseColor--link"  href="https://medium.com/@networksecurity?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="7db6d2df42a6" data-action-type="hover" data-user-id="7db6d2df42a6" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/60/60/1*bAnzT3NFn-9L1xf_XWqzgA.jpeg" class="avatar-image avatar-image--small" alt="Go to the profile of Kevin Beaumont"></a></div><div class="u-flex1 u-paddingLeft15 u-overflowHidden"><a class="link link link--darken link--darker u-baseColor--link"  href="https://medium.com/@networksecurity?source=post_header_lockup" data-action="show-user-card" data-action-source="post_header_lockup" data-action-value="7db6d2df42a6" data-action-type="hover" data-user-id="7db6d2df42a6" dir="auto">Kevin Beaumont</a><span class="followState js-followState buttonSet-inner" data-user-id="7db6d2df42a6"><button class="button u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="post_header_lockup"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary u-paddingLeft10 u-paddingRight10 u-height19 u-lineHeight13 u-verticalAlignMiddle u-fontSize12 u-uiTextMedium u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-marginLeft10 u-marginTopNegative2 u-xs-hide"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/7db6d2df42a6" data-action-source="post_header_lockup_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span><div class="postMetaInline u-noWrapWithEllipsis u-xs-normalWrap u-xs-lineClamp2">IT Security, from the trenches of reality. Liverpool, UK based. Email kevin.beaumont@gmail.com | Twitter: @gossithedog on Twitter.</div><div class="postMetaInline js-testPostMetaInlineSupplemental"><time datetime="2017-03-19T23:55:46.180Z">3 days ago</time><span class="middotDivider u-fontSize12"></span><span class="readingTime" title="7 min read"></span></div></div></div></div></div></header><div class="postArticle-content js-postField js-notesSource js-trackedPost"  data-post-id="da2a1e73a5f6" data-source="post_page" data-tracking-context="postPage"><section name="adb2" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h1 name="127f" id="127f" class="graf graf--h3 graf--leading graf--title">RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an organisation</h1><h2 name="f58f" id="f58f" class="graf graf--h4 graf-after--h3 graf--subtitle">How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to defend against it.</h2><figure name="a559" id="a559" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 480px; max-height: 274px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 57.099999999999994%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*bd6ZhReKUzjJwunNpA6cDg.gif" data-width="480" data-height="274"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*bd6ZhReKUzjJwunNpA6cDg.gif?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*bd6ZhReKUzjJwunNpA6cDg.gif"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*bd6ZhReKUzjJwunNpA6cDg.gif"></noscript></div></div><figcaption class="imageCaption">Alexander Korznikov demonstrates using Sticky Keys and tscon to access an administrator RDP session — without even logging into the server.</figcaption></figure><h4 name="a625" id="a625" class="graf graf--h4 graf-after--figure">Brief background on RDP session connection</h4><p name="9669" id="9669" class="graf graf--p graf-after--h4">If you’ve used Remote Desktop Services before, or Terminal Services if you’re as old as me, you will know there’s a feature where you connect to another user’s session — <em class="markup--em markup--p-em">if you know their password. </em>Did you know you can also hijack a session without the user password? Read on.</p><p name="c10c" id="c10c" class="graf graf--p graf-after--p">You can right click a user in Task Manager, use tsadmin.msc, or use the command tscon.exe. It will ask for a password, and bomb if you can’t authenticate as the user:</p><figure name="814f" id="814f" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 287px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 41.099999999999994%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*Wr_SRDwI4hYKClcVKc0rrQ.png" data-width="1410" data-height="579" data-action="zoom" data-action-value="1*Wr_SRDwI4hYKClcVKc0rrQ.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*Wr_SRDwI4hYKClcVKc0rrQ.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*Wr_SRDwI4hYKClcVKc0rrQ.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*Wr_SRDwI4hYKClcVKc0rrQ.png"></noscript></div></div></figure><h4 name="a086" id="a086" class="graf graf--h4 graf-after--figure">Some tricks allow credential-less Session Hijacking</h4><p name="e7b4" id="e7b4" class="graf graf--p graf-after--h4">Here’s the deal. As revealed by by <a href="http://blog.gentilkiwi.com/securite/vol-de-session-rdp" data-href="http://blog.gentilkiwi.com/securite/vol-de-session-rdp" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Benjamin Delpy</a> (of Mimikatz) in 2011 and by <a href="http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html" data-href="http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">Alexander Korznikov</a> on Friday, if you run tscon.exe as the SYSTEM user, <strong class="markup--strong markup--p-strong">you can connect to any session without a password</strong>. It doesn’t prompt, it just connects you to the user’s desktop. I believe this is due to the way session shadowing was implemented in Microsoft Windows, and it runs throughout the years like this.</p><p name="576b" id="576b" class="graf graf--p graf-after--p">Now, you might be saying ‘If you’re SYSTEM, you’re already root… You can already do anything’.</p><p name="b0e3" id="b0e3" class="graf graf--p graf-after--p">Yes. Yes you can. You could, for example, dump out the server memory and get user passwords. That’s a long process compared to just running tscon.exe with a session number, and instantly get the desktop of said user — with no obvious trace, or external tools. This isn’t about SYSTEM — this is about what you can do with it very quickly, and quietly. Attackers aren’t interested in playing, they’re interested in what they can do with techniques. This is a very valid technique.</p><p name="322b" id="322b" class="graf graf--p graf-after--p">So, you have full blown RDP session hijacking, with a single command.</p><h4 name="6400" id="6400" class="graf graf--h4 graf-after--p">Some parameters about how far this reaches</h4><ul class="postList"><li name="a30f" id="a30f" class="graf graf--li graf-after--h4">You can connect to disconnected sessions. So if somebody logged out 3 days ago, you can just connect straight to their session and start using it.</li><li name="167a" id="167a" class="graf graf--li graf-after--li">It unlocks locked sessions. So if a user is away from their desk, you steal their session AND it unlocks the ‘workstation’ without needing any credentials.</li><li name="0193" id="0193" class="graf graf--li graf-after--li">It works for the physical console. So you can hijack the screen remotely. It also unlocks the physical console, too.</li><li name="99f5" id="99f5" class="graf graf--li graf-after--li">You can connect to ANY session — so if, for example, it’s the Helpdesk, you can connect to it without any authentication. If it’s a Domain Admin, you’re in. Because of the above point (you can connect to disconnected sessions), this makes it an incredibly simple way to laterally move through a network.</li><li name="2544" id="2544" class="graf graf--li graf-after--li">You can use win32k <a href="https://arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/" data-href="https://arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">SYSTEM exploits</a> — there are many — to gain SYSTEM permissions, and then use this feature. Meaning even as a standard user, if patches aren’t applied properly you can use this. Obviously, any route to SYSTEM is valid — e.g. any method to get to a local administrator (there’s a few!).</li><li name="f4df" id="f4df" class="graf graf--li graf-after--li">There are no external tools. Nothing to get through application whitelisting. No executable is written to disk.</li><li name="faf2" id="faf2" class="graf graf--li graf-after--li">Unless you know what to monitor (more on that later), you won’t know this is happening.</li><li name="fb14" id="fb14" class="graf graf--li graf-after--li">It works remotely. You can take over sessions on remote computers, even if you’re not logged into that server.</li></ul><h4 name="e8fa" id="e8fa" class="graf graf--h4 graf-after--li">Gaining SYSTEM for tscon.exe</h4><p name="7edc" id="7edc" class="graf graf--p graf-after--h4">If you’re an administrator, you can use a service as Alexander demonstrates:</p><figure name="7e47" id="7e47" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 367px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 52.5%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*S5y5lGUCtZXvGQi7IpHpew.png" data-width="1231" data-height="646" data-action="zoom" data-action-value="1*S5y5lGUCtZXvGQi7IpHpew.png"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*S5y5lGUCtZXvGQi7IpHpew.png?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*S5y5lGUCtZXvGQi7IpHpew.png"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*S5y5lGUCtZXvGQi7IpHpew.png"></noscript></div></div></figure><p name="4dc7" id="4dc7" class="graf graf--p graf-after--figure">In essence it is really easy, just use the quser command to get the Session ID you want to hijack, and your own SESSIONNAME. Then run tscon with the Session ID for hijack, and your own SESSIONNAME. Your own Session will be replaced with the hijacked session. The service will run as SYSTEM by default — you’re in.</p><p name="f815" id="f815" class="graf graf--p graf-after--p">Just remember to delete the service afterwards, if you’re evil.</p><p name="206e" id="206e" class="graf graf--p graf-after--p">Here’s an example of it in practice on a Windows Server 2012 R2 server:</p><p name="dd57" id="dd57" class="graf graf--p graf-after--p"><a href="https://www.youtube.com/watch?v=OgsoIoWmhWw" data-href="https://www.youtube.com/watch?v=OgsoIoWmhWw" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.youtube.com/watch?v=OgsoIoWmhWw</a></p><p name="34ea" id="34ea" class="graf graf--p graf-after--p">Other methods:</p><ul class="postList"><li name="fa55" id="fa55" class="graf graf--li graf-after--p">You can use Scheduled Tasks to gain SYSTEM and run the command. Just schedule the command to run immediately as SYSTEM with interactive privileges.</li><li name="e0fb" id="e0fb" class="graf graf--li graf-after--li">Use can use a variety of methods like Sticky Keys to get SYSTEM, without even needing to log in (in the future). See below.</li><li name="00cc" id="00cc" class="graf graf--li graf-after--li">Exploits etc (see above).</li></ul><h4 name="1dfb" id="1dfb" class="graf graf--h4 graf-after--li">Lateral movement</h4><p name="6555" id="6555" class="graf graf--p graf-after--h4">Most organisations allow Remote Desktop through their internal network, because it’s 2017 and that’s how Windows administration works. Also, RemoteApp uses RDP. Because of this, it’s a fantastic way to move around an organisation’s network — forget passwords, just surf around and abuse other people’s access. You appear in the organisation logs as that user, not yourself.</p><h4 name="875d" id="875d" class="graf graf--h4 graf-after--p">How to backdoor for credential-less hijacking</h4><p name="652e" id="652e" class="graf graf--p graf-after--h4">Remote Desktop bruteforcing is a major problem. Anybody who has setup a honeypot recently will know within seconds you will be getting hit with failed RDP logins. First they portscan, then thousands of login attempts arrive.</p><p name="ea52" id="ea52" class="graf graf--p graf-after--p">It gets worse — I run RDP honeypots, and I see them regularly — when breached they get backdoored using the techniques below.</p><p name="3547" id="3547" class="graf graf--p graf-after--p">From research, over 1 in 200 scanned Remote Desktop servers online are already backdoored using these methods. This means that you can session hijack with them right now, without even needing to try to log in or authenticate in any way. That’s bad. Consider Shodan shows there are millions of RDP servers online right now, and the number grows constantly with cloud services etc, this is going to generate… issues.</p><h4 name="b6c3" id="b6c3" class="graf graf--h4 graf-after--p">RDP backdoor method one — Sticky Keys</h4><p name="c755" id="c755" class="graf graf--p graf-after--h4">The concept here is pretty simple — Windows supports a feature called Sticky Keys, which is an Accessibility feature built into the OS and available pre-logon (at the login screen, either via a physical console or via Remote Desktop). It runs as SYSTEM.</p><p name="57df" id="57df" class="graf graf--p graf-after--p">If you set Sethc.exe (Sticky Keys) to spawn cmd.exe, you have a backdoor you can use if you are locked out of a box — you have SYSTEM access, so you can do anything even without an account. You can do this by either replacing sethc.exe with cmd.exe — this requires a reboot, and physical access to the box — or just set the registry key using the command below.</p><pre name="139b" id="139b" class="graf graf--pre graf-after--p">REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; /t REG_SZ /v Debugger /d “C:\windows\system32\cmd.exe” /f</pre><p name="e4ab" id="e4ab" class="graf graf--p graf-after--pre">Ta-da! The box is now permanently backdoored. Just Remote Desktop in and at the login screen, hit F5 a bunch of times.</p><h4 name="d16d" id="d16d" class="graf graf--h4 graf-after--p">Method two — Utilman</h4><p name="06e4" id="06e4" class="graf graf--p graf-after--h4">It’s exactly the same as before, just trojan utilman.exe instead. At the login screen, press Windows Key+U, and you get a cmd.exe window as SYSTEM.</p><pre name="7442" id="7442" class="graf graf--pre graf-after--p">REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe&quot; /t REG_SZ /v Debugger /d “C:\windows\system32\cmd.exe” /f</pre><h4 name="c067" id="c067" class="graf graf--h4 graf-after--pre">Scanning for backdoor’d RDP servers</h4><p name="cc64" id="cc64" class="graf graf--p graf-after--h4">There is a prebuilt tool here, which works wonders — just spin it up and find servers which already have a SYSTEM level backdoor exposed:</p><div name="4f16" id="4f16" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/ztgrace/sticky_keys_hunter" data-href="https://github.com/ztgrace/sticky_keys_hunter" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/ztgrace/sticky_keys_hunter" rel="nofollow"><strong class="markup--strong markup--mixtapeEmbed-strong">ztgrace/sticky_keys_hunter</strong><br><em class="markup--em markup--mixtapeEmbed-em">sticky_keys_hunter - A script to test an RDP host for sticky keys and utilman backdoor.</em>github.com</a><a href="https://github.com/ztgrace/sticky_keys_hunter" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="7a743010bb8152949a3ee889bdd38a04" data-thumbnail-img-id="0*UEsyEzNqcXOl_9ih." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*UEsyEzNqcXOl_9ih.);"></a></div><p name="ff6c" id="ff6c" class="graf graf--p graf-after--mixtapeEmbed">From online scanning, a significant amount of open RDP servers online are already backdoored.</p><h4 name="a5b4" id="a5b4" class="graf graf--h4 graf-after--p">Mimikatz module</h4><p name="aeeb" id="aeeb" class="graf graf--p graf-after--h4">There is now a Mimikatz module for very easily doing this:</p><div name="b09b" id="b09b" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://github.com/gentilkiwi/mimikatz/releases" data-href="https://github.com/gentilkiwi/mimikatz/releases" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://github.com/gentilkiwi/mimikatz/releases" rel="nofollow"><strong class="markup--strong markup--mixtapeEmbed-strong">gentilkiwi/mimikatz</strong><br><em class="markup--em markup--mixtapeEmbed-em">mimikatz - A little tool to play with Windows security</em>github.com</a><a href="https://github.com/gentilkiwi/mimikatz/releases" class="js-mixtapeImage mixtapeImage u-ignoreBlock" data-media-id="35f337436609fd741f52628740d9e66f" data-thumbnail-img-id="0*vEmdb17TmcRb5Tqo." style="background-image: url(https://cdn-images-1.medium.com/fit/c/160/160/0*vEmdb17TmcRb5Tqo.);"></a></div><figure name="bf82" id="bf82" class="graf graf--figure graf-after--mixtapeEmbed"><div class="aspectRatioPlaceholder is-locked" style="max-width: 600px; max-height: 387px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 64.5%;"></div><div class="progressiveMedia js-progressiveMedia graf-image" data-image-id="1*oFF3A3KhTzGrEnS_3vV36g.gif" data-width="600" data-height="387"><img src="https://cdn-images-1.medium.com/freeze/max/30/1*oFF3A3KhTzGrEnS_3vV36g.gif?q=20" crossorigin="anonymous" class="progressiveMedia-thumbnail js-progressiveMedia-thumbnail"><canvas class="progressiveMedia-canvas js-progressiveMedia-canvas"></canvas><img class="progressiveMedia-image js-progressiveMedia-image" data-src="https://cdn-images-1.medium.com/max/800/1*oFF3A3KhTzGrEnS_3vV36g.gif"><noscript class="js-progressiveMedia-inner"><img class="progressiveMedia-noscript js-progressiveMedia-inner" src="https://cdn-images-1.medium.com/max/800/1*oFF3A3KhTzGrEnS_3vV36g.gif"></noscript></div></div><figcaption class="imageCaption">gentilkiwi rocking it</figcaption></figure><h4 name="db3c" id="db3c" class="graf graf--h4 graf-after--figure">Mitigations</h4><p name="e444" id="e444" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">OS</strong>-I had a section about Window Server 2016 here, however after further investigation it appears to also be impacted. After testing this applies to every OS since Windows 2000, including Windows 10 and 2016.</p><p name="6ea7" id="6ea7" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Group Policy </strong>— I strongly recommend you use Group Policy to log off disconnected sessions, either immediately or soon after the user disconnects. This will NOT be popular in IT environments — but the risk is now completely real that they can very easily — with one built in command — be hijacked more or less silently in the real world. I would also log off idle sessions.</p><p name="ec3c" id="ec3c" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Don’t expose RDS/RDP to the internet </strong>— if you do, I <strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">strongly suggest </em></strong>you implement multi-factor authentication. You can use things like Microsoft RD Gateway or Azure Multi-Factor Authentication Server to get very low cost multi-factor authentication. If you’re exposing RDP directly to the internet and somebody creates a local user or your domain users have easy to guess or reused credentials, things will go downhill fast. Trust me — I’ve seen hospitals and others be ransomware’d by RDS servers.</p><h4 name="1479" id="1479" class="graf graf--h4 graf-after--p">Monitoring</h4><p name="c6da" id="c6da" class="graf graf--p graf-after--h4">It is surprisingly very difficult to record session hijacking — there is one event log (Microsoft-Windows-TerminalServices-LocalSessionManager/Operational) which records sessions connecting — however it does not appear to differentiate between a normal user connecting and tscon.exe being used — I’ve been through every other event log and can’t see anything which suggests this is happening. This is actually a major issue and I lobby Microsoft to add some kind of Event Log ASAP — it’s a real gap.</p><p name="495e" id="495e" class="graf graf--p graf-after--p">My suggestion is you alert for other related behaviour using the Event Log and tools like Microsoft OMS, Windows Event Forwarding, Splunk etc. You’re looking for SYSTEM being misused.</p><p name="f98b" id="f98b" class="graf graf--p graf-after--p">For example abnormal Service creation and abnormal scheduled task creation should be logged centrally, and recorded against. Additionally, you can look for Mimikatz related activity.</p><ul class="postList"><li name="78e4" id="78e4" class="graf graf--li graf-after--p">k</li></ul><h4 name="5fd2" id="5fd2" class="graf graf--h4 graf-after--li">FAQ</h4><p name="6aca" id="6aca" class="graf graf--p graf-after--h4">Q: This isn’t new or a vulnerability.</p><p name="7825" id="7825" class="graf graf--p graf-after--p">A: Java applets and macros aren’t new. If the technique works, it will get used. This one has flown under the radar — that doesn’t mean it is not valid.</p><p name="9a4f" id="9a4f" class="graf graf--p graf-after--p">Q: If you have SYSTEM you already own the box.</p><p name="e25f" id="e25f" class="graf graf--p graf-after--p graf--trailing">A: Correct. Can you type one command and get the unlocked desktop of a user, even if they went on holiday a week ago, without a log of it? Now you can.</p></div></div></section></div><footer class="u-paddingTop10"><div class="container u-maxWidth740"><div class="row"><div class="col u-size12of12"></div></div><div class="row"><div class="col u-size12of12 js-postTags"><div class="u-paddingBottom10"><ul class="tags tags--postTags tags--borderless"><li><a class="link u-baseColor--link"  href="https://medium.com/tag/microsoft?source=post" data-action-source="post">Microsoft</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/sysadmin?source=post" data-action-source="post">Sysadmin</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/rds?source=post" data-action-source="post">Rds</a></li><li><a class="link u-baseColor--link"  href="https://medium.com/tag/hijack?source=post" data-action-source="post">Hijack</a></li></ul></div></div></div><div class="row js-postActionsFooter"><div class="postActions col u-size12of12"><div class="u-floatLeft buttonSet buttonSet--withLabels"><div class="buttonSet-inner"><div class="js-actionRecommend" data-post-id="da2a1e73a5f6" data-is-icon-29px="true" data-has-recommend-list="true" data-source="post_actions_footer"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/da2a1e73a5f6" data-action-source="post_actions_footer"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal"  data-action="show-recommends" data-action-value="da2a1e73a5f6">21</button></div></div><div class="buttonSet-inner"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  data-action="scroll-to-responses" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--response svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.27 20.058c1.89-1.826 2.754-4.17 2.754-6.674C24.024 8.21 19.67 4 14.1 4 8.53 4 4 8.21 4 13.384c0 5.175 4.53 9.385 10.1 9.385 1.007 0 2-.14 2.95-.41.285.25.592.49.918.7 1.306.87 2.716 1.31 4.19 1.31.276-.01.494-.14.6-.36a.625.625 0 0 0-.052-.65c-.61-.84-1.042-1.71-1.282-2.58a5.417 5.417 0 0 1-.154-.75zm-3.85 1.324l-.083-.28-.388.12a9.72 9.72 0 0 1-2.85.424c-4.96 0-8.99-3.706-8.99-8.262 0-4.556 4.03-8.263 8.99-8.263 4.95 0 8.77 3.71 8.77 8.27 0 2.25-.75 4.35-2.5 5.92l-.24.21v.32c0 .07 0 .19.02.37.03.29.1.6.19.92.19.7.49 1.4.89 2.08-.93-.14-1.83-.49-2.67-1.06-.34-.22-.88-.48-1.16-.74z"/></svg></span></button></div></div><div class="u-floatRight buttonSet buttonSet--narrow"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_actions_footer"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></div></div></div></div><div class="js-postPromotionWrapper postPromotionWrapper" data-location-id="footer_above_post_attribution"></div><div class="container u-maxWidth740 js-postAttributionFooterContainer u-paddingTop20 u-paddingBottom20 u-marginTop10 u-borderTopLightest u-xs-paddingTop10 u-xs-paddingBottom10"><div class="row js-postFooterInfo"><div class="col u-size12of12"><li class="u-block u-paddingBottom18 js-cardUser"><div class="u-marginLeft20 u-floatRight"><span class="followState js-followState buttonSet-inner" data-user-id="7db6d2df42a6"><button class="button button--small u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="footer_card"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary button--small u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/7db6d2df42a6" data-action-source="footer_card_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Following</span></button></span></div><div class="u-tableCell "><a class="link avatar u-baseColor--link"  href="https://medium.com/@networksecurity?source=footer_card" title="Go to the profile of Kevin Beaumont" aria-label="Go to the profile of Kevin Beaumont" data-action-source="footer_card" data-user-id="7db6d2df42a6" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/60/60/1*bAnzT3NFn-9L1xf_XWqzgA.jpeg" class="avatar-image avatar-image--small" alt="Go to the profile of Kevin Beaumont"></a></div><div class="u-tableCell u-verticalAlignMiddle u-breakWord u-paddingLeft15"><h3 class="u-fontSize18 u-lineHeightTighter u-marginBottom4"><a class="link link--primary u-accentColor--hoverTextNormal"  href="https://medium.com/@networksecurity" property="cc:attributionName" title="Go to the profile of Kevin Beaumont" aria-label="Go to the profile of Kevin Beaumont" rel="author cc:attributionUrl" data-user-id="7db6d2df42a6" dir="auto">Kevin Beaumont</a></h3><p class="u-fontSize14 u-lineHeightBaseSans u-textColorDark u-marginBottom4">IT Security, from the trenches of reality. Liverpool, UK based. Email <a rel="nofollow" href="mailto:kevin.beaumont@gmail.com">kevin.beaumont@gmail.com</a> | Twitter: <a href="http://twitter.com/gossithedog" target="_blank" title="Twitter profile for @gossithedog">@gossithedog</a> on Twitter.</p></div></li></div></div></div><div class="js-postFooterPlacements"></div><div class="u-padding0 u-clearfix u-backgroundGrayLightest u-print-hide supplementalPostContent js-responsesWrapper"></div><div class="supplementalPostContent js-readNext"></div><div class="supplementalPostContent js-heroPromo"></div></footer></article></main><div class="u-marginAuto u-maxWidth1000"><div class="js-postShareWidget u-foreground u-sm-hide u-transition--fadeOut300 u-fixed"><ul><li class="u-uiTextSemibold u-textAlignCenter u-textColorNormal u-fontSize12 u-textUppercase">Share</li><li class="u-textAlignCenter"><div class="js-actionRecommend" data-post-id="da2a1e73a5f6" data-is-icon-29px="true" data-is-vertical="true" data-has-recommend-list="true" data-source="post_share_widget"><button class="button button--primary button--large button--chromeless is-touchIconFadeInPulse u-accentColor--buttonNormal button--withIcon button--withSvgIcon u-accentColor--iconLight js-actionRecommendButton"  title="Recommend to share this article with your followers and let the author know you liked it" aria-label="Recommend to share this article with your followers and let the author know you liked it" data-action="sign-in-prompt" data-sign-in-action="upvote" data-requires-token="true" data-redirect="https://medium.com/_/vote/p/da2a1e73a5f6" data-action-source="post_share_widget"><span class="button-defaultState"><span class="svgIcon svgIcon--heart svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.215 23.716c-.348.288-.984.826-1.376 1.158a.526.526 0 0 1-.68 0c-.36-.307-.92-.78-1.22-1.03C9.22 20.734 3 15.527 3 10.734 3 7.02 5.916 4 9.5 4c1.948 0 3.77.898 5 2.434C15.73 4.898 17.552 4 19.5 4c3.584 0 6.5 3.02 6.5 6.734 0 4.9-6.125 9.96-9.785 12.982zM19.5 5.2c-1.774 0-3.423.923-4.41 2.468a.699.699 0 0 1-.59.323.706.706 0 0 1-.59-.32c-.988-1.54-2.637-2.47-4.41-2.47-2.922 0-5.3 2.49-5.3 5.54 0 4.23 6.19 9.41 9.517 12.19.217.18.566.48.783.66l.952-.79c3.496-2.88 9.348-7.72 9.348-12.05 0-3.05-2.378-5.53-5.3-5.53z"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--heartFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.5 4c-1.948 0-3.77.898-5 2.434C13.27 4.898 11.448 4 9.5 4 5.916 4 3 7.02 3 10.734c0 4.793 6.227 10 9.95 13.11.296.25.853.723 1.212 1.03.196.166.48.166.677 0 .39-.332 1.02-.87 1.37-1.158 3.66-3.022 9.79-8.08 9.79-12.982C26 7.02 23.08 4 19.5 4z" fill-rule="evenodd"/></svg></span></span></button><button class="button button--chromeless u-baseColor--buttonNormal  u-block u-marginAuto u-marginTopNegative5"  data-action="show-recommends" data-action-value="da2a1e73a5f6">21</button></div></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Twitter" aria-label="Share on Twitter" data-action="share-on-twitter" data-action-source="post_share_widget"><span class="svgIcon svgIcon--twitter svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M21.967 11.8c.018 5.93-4.607 11.18-11.177 11.18-2.172 0-4.25-.62-6.047-1.76l-.268.422-.038.5.186.013.168.012c.3.02.44.032.6.046 2.06-.026 3.95-.686 5.49-1.86l1.12-.85-1.4-.048c-1.57-.055-2.92-1.08-3.36-2.51l-.48.146-.05.5c.22.03.48.05.75.08.48-.02.87-.07 1.25-.15l2.33-.49-2.32-.49c-1.68-.35-2.91-1.83-2.91-3.55 0-.05 0-.01-.01.03l-.49-.1-.25.44c.63.36 1.35.57 2.07.58l1.7.04L7.4 13c-.978-.662-1.59-1.79-1.618-3.047a4.08 4.08 0 0 1 .524-1.8l-.825.07a12.188 12.188 0 0 0 8.81 4.515l.59.033-.06-.59v-.02c-.05-.43-.06-.63-.06-.87a3.617 3.617 0 0 1 6.27-2.45l.2.21.28-.06c1.01-.22 1.94-.59 2.73-1.09l-.75-.56c-.1.36-.04.89.12 1.36.23.68.58 1.13 1.17.85l-.21-.45-.42-.27c-.52.8-1.17 1.48-1.92 2L22 11l.016.28c.013.2.014.35 0 .52v.04zm.998.038c.018-.22.017-.417 0-.66l-.498.034.284.41a8.183 8.183 0 0 0 2.2-2.267l.97-1.48-1.6.755c.17-.08.3-.02.34.03a.914.914 0 0 1-.13-.292c-.1-.297-.13-.64-.1-.766l.36-1.254-1.1.695c-.69.438-1.51.764-2.41.963l.48.15a4.574 4.574 0 0 0-3.38-1.484 4.616 4.616 0 0 0-4.61 4.613c0 .29.02.51.08.984l.01.02.5-.06.03-.5c-3.17-.18-6.1-1.7-8.08-4.15l-.48-.56-.36.64c-.39.69-.62 1.48-.65 2.28.04 1.61.81 3.04 2.06 3.88l.3-.92c-.55-.02-1.11-.17-1.6-.45l-.59-.34-.14.67c-.02.08-.02.16 0 .24-.01 2.12 1.55 4.01 3.69 4.46l.1-.49-.1-.49c-.33.07-.67.12-1.03.14-.18-.02-.43-.05-.64-.07l-.76-.09.23.73c.57 1.84 2.29 3.14 4.28 3.21l-.28-.89a8.252 8.252 0 0 1-4.85 1.66c-.12-.01-.26-.02-.56-.05l-.17-.01-.18-.01L2.53 21l1.694 1.07a12.233 12.233 0 0 0 6.58 1.917c7.156 0 12.2-5.73 12.18-12.18l-.002.04z"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconBlackPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon"  title="Share on Facebook" aria-label="Share on Facebook" data-action="share-on-facebook" data-action-source="post_share_widget"><span class="svgIcon svgIcon--facebook svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M16.39 23.61v-5.808h1.846a.55.55 0 0 0 .546-.48l.36-2.797a.551.551 0 0 0-.547-.62H16.39V12.67c0-.67.12-.813.828-.813h1.474a.55.55 0 0 0 .55-.55V8.803a.55.55 0 0 0-.477-.545c-.436-.06-1.36-.116-2.22-.116-2.5 0-4.13 1.62-4.13 4.248v1.513H10.56a.551.551 0 0 0-.55.55v2.797c0 .304.248.55.55.55h1.855v5.76c-4.172-.96-7.215-4.7-7.215-9.1 0-5.17 4.17-9.36 9.31-9.36 5.14 0 9.31 4.19 9.31 9.36 0 4.48-3.155 8.27-7.43 9.15M14.51 4C8.76 4 4.1 8.684 4.1 14.46c0 5.162 3.75 9.523 8.778 10.32a.55.55 0 0 0 .637-.543v-6.985a.551.551 0 0 0-.55-.55H11.11v-1.697h1.855a.55.55 0 0 0 .55-.55v-2.063c0-2.02 1.136-3.148 3.03-3.148.567 0 1.156.027 1.597.06v1.453h-.924c-1.363 0-1.93.675-1.93 1.912v1.78c0 .3.247.55.55.55h2.132l-.218 1.69H15.84c-.305 0-.55.24-.55.55v7.02c0 .33.293.59.623.54 5.135-.7 9.007-5.11 9.007-10.36C24.92 8.68 20.26 4 14.51 4"/></svg></span></button></li><li class="u-textAlignCenter"><button class="button button--large button--dark button--chromeless is-touchIconFadeInPulse u-baseColor--buttonDark button--withIcon button--withSvgIcon button--bookmark js-bookmarkButton"  title="Bookmark this story to read later" aria-label="Bookmark this story to read later" data-action="sign-in-prompt" data-sign-in-action="add-to-bookmarks" data-requires-token="true" data-redirect="https://medium.com/_/bookmark/p/da2a1e73a5f6"><span class="button-defaultState"><span class="svgIcon svgIcon--bookmark svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4zM21 23l-5.91-3.955-.148-.107a.751.751 0 0 0-.884 0l-.147.107L8 23V6.615C8 5.725 8.725 5 9.615 5h9.77C20.275 5 21 5.725 21 6.615V23z" fill-rule="evenodd"/></svg></span></span><span class="button-activeState"><span class="svgIcon svgIcon--bookmarkFilled svgIcon--29px"><svg class="svgIcon-use" width="29" height="29" viewBox="0 0 29 29" ><path d="M19.385 4h-9.77A2.623 2.623 0 0 0 7 6.615V23.01a1.022 1.022 0 0 0 1.595.847l5.905-4.004 5.905 4.004A1.022 1.022 0 0 0 22 23.011V6.62A2.625 2.625 0 0 0 19.385 4z" fill-rule="evenodd"/></svg></span></span></button></li></ul></div></div><div class="u-fixed u-bottom0 u-sizeFullWidth u-backgroundWhite u-boxShadowTop u-borderBox u-paddingTop10 u-paddingBottom10 u-zIndexMetabar u-xs-paddingLeft10 u-xs-paddingRight10 js-stickyFooter"><div class="u-maxWidth700 u-marginAuto u-flexCenter"><div class="u-fontSize16 u-flex1 u-flexCenter"><div class="u-flex0 u-inlineBlock u-paddingRight20 u-xs-paddingRight10"><a class="link avatar u-inline u-baseColor--link"  href="https://medium.com/@networksecurity" data-action="show-user-card" data-action-value="7db6d2df42a6" data-action-type="hover" data-user-id="7db6d2df42a6" dir="auto"><img  src="https://cdn-images-1.medium.com/fit/c/40/40/1*bAnzT3NFn-9L1xf_XWqzgA.jpeg" class="avatar-image avatar-image--smaller" alt="Go to the profile of Kevin Beaumont"></a></div><div class="u-flex1 u-inlineBlock"><div class="u-xs-hide">Never miss a story from<strong> Kevin Beaumont</strong>, when you sign up for Medium. <a class="link link--accent u-accentColor--textNormal u-accentColor--textDarken u-baseColor--link"  href="https://medium.com/@Medium/personalize-your-medium-experience-with-users-publications-tags-26a41ab1ee0c#.hx4zuv3mg" data-action-source="sticky_footer">Learn more</a></div><div class="u-xs-show">Never miss a story from<strong> Kevin Beaumont</strong></div></div></div><div class="u-marginLeft50 u-xs-marginAuto"><span class="followState js-followState buttonSet-inner" data-user-id="7db6d2df42a6"><button class="button u-noUserSelect button--withChrome u-baseColor--buttonNormal button--withHover button--unblock js-unblockButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-block-user" data-requires-token="true" data-action-source="sticky_footer"><span class="button-label  button-defaultState">Blocked</span><span class="button-label button-hoverState">Unblock</span></button><button class="button button--primary is-active u-noUserSelect button--withChrome u-accentColor--buttonNormal button--follow js-followButton u-uiTextSemibold u-textUppercase u-fontSize12"  data-action="sign-in-prompt" data-sign-in-action="toggle-subscribe-user" data-requires-token="true" data-redirect="https://medium.com/_/subscribe/user/7db6d2df42a6" data-action-source="sticky_footer_follow"><span class="button-label  button-defaultState js-buttonLabel">Follow</span><span class="button-label button-activeState">Get updates</span></button></span></div></div></div></div></div></div><div class="loadingBar"></div><script>// <![CDATA[
window["obvInit"] = function (opt_embedded) {window["obvInit"]["embedded"] = opt_embedded; window["obvInit"]["ready"] = true;}
// ]]></script><script>// <![CDATA[
var GLOBALS = {"audioUrl":"https://d1fcbxp97j4nb2.cloudfront.net","baseUrl":"https://medium.com","buildLabel":"28249","currentUser":{"userId":"lo_dnt_58749e281730","isVerified":false,"subscriberEmail":""},"currentUserHasUnverifiedEmail":false,"isAuthenticated":false,"isCurrentUserVerified":false,"language":"de-de","mediumTwitterScreenName":"medium","miroUrl":"https://cdn-images-1.medium.com","moduleUrls":{"base":"https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.G8dRKaC1ISGlp_vW2NEIXQ.js","notes":"https://cdn-static-1.medium.com/_/fp/gen-js/main-notes.bundle.sZq-w_kR2Oc50dF8-DPLjg.js","posters":"https://cdn-static-1.medium.com/_/fp/gen-js/main-posters.bundle.b6i5MojOW7OhUgQ4tcfLxQ.js","common-async":"https://cdn-static-1.medium.com/_/fp/gen-js/main-common-async.bundle.L88hebS2SuVj5T-YlX86Bw.js","stats":"https://cdn-static-1.medium.com/_/fp/gen-js/main-stats.bundle.emXTJEMbjTUtL4QGDHqbZg.js","home-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-home-screens.bundle.EQE5ifnUthQOT5iR4Sso8w.js","misc-screens":"https://cdn-static-1.medium.com/_/fp/gen-js/main-misc-screens.bundle.npZBXzxQupic3DdIuSC3Tg.js"},"previewConfig":{"weightThreshold":1,"weightImageParagraph":0.51,"weightIframeParagraph":0.8,"weightTextParagraph":0.08,"weightEmptyParagraph":0,"weightP":0.003,"weightH":0.005,"weightBq":0.003,"minPTextLength":60,"truncateBoundaryChars":20,"detectTitle":true,"detectTitleLevThreshold":0.15},"productName":"Medium","supportsEdit":true,"termsUrl":"//medium.com/policy/9db0094a1e0f","textshotHost":"textshot.medium.com","transactionId":"1490184428350:fd2b29470148","useragent":{"browser":"chrome","family":"chrome","os":"","version":57,"supportsDesktopEdit":true,"supportsInteract":true,"supportsView":true,"isMobile":false,"isTablet":false,"isNative":false,"supportsFileAPI":true,"isTier1":true,"clientVersion":"","unknownParagraphsBad":false,"clientChannel":"","supportsRealScrollEvents":true,"supportsVhUnits":true,"ruinsViewportSections":false,"supportsHtml5Video":true,"supportsMagicUnderlines":true,"isWebView":false,"isFacebookWebView":false,"supportsProgressiveMedia":true,"supportsPromotedPosts":true,"isBot":false,"isNativeIphone":false,"supportsCssVariables":true,"supportsScrollableMetabar":true},"variants":{"allow_access":true,"allow_signup":true,"allow_test_auth":"disallow","signin_services":"twitter,facebook,google,email,google-fastidv","signup_services":"twitter,facebook,google,email,google-fastidv","android_rating_prompt_recommend_threshold":5,"google_sign_in_android":true,"enable_onboarding":true,"ios_custom_miro_url":"https://cdn-images-1.medium.com","reengagement_notification_duration":3,"browsable_stream_config_bucket":"curated","ios_small_post_preview_truncation_length":5.5,"ios_large_post_preview_truncation_length":5.5,"disable_ios_catalog_badging":true,"enable_series_creation":true,"enable_your_series_pages":true,"enable_productionized_series":true,"enable_dedicated_series_tab_api_ios":true,"enable_clap_milestone_notifications":true,"enable_series_stats_page":true,"enable_prepublish_share_settings":true,"enable_direct_auth_connect":true,"enable_post_import":true,"enable_sponsored_post_labelling":true,"promoted_story_placement_locations":"POST_PAGE_FOOTER","prmt_to_people_experiment":"default","show_topics":true,"enable_related_reads_curse_words_filtering":true,"enable_search_collection_by_tag_recency_filter":true,"search_collection_by_tag_filter_min_votes":10,"enable_drag_and_drop_ui":true,"enable_catalog_takeover_route":true,"enable_crex_directory":true,"enable_client_digest":true,"honeypot_footer_copy_strategy":1,"enable_sms_app_promo":true,"enable_export_members":true,"enable_series_card_background_creation":true,"enable_bento_homepage":true,"enable_publication_popovers":true,"enable_hide_broken_links":true,"enable_pay_for_custom_domain":true,"enable_promos_from_dynamo":true,"enable_intercom_integration":true,"double_write_post_from_followed_tag_items":true,"enable_series_promo_in_email":true,"enable_sms":true,"enable_series_in_user_profiles":true},"xsrfToken":"","iosAppId":"828256236","supportEmail":"yourfriends@medium.com","teamName":"Team Medium","fp":{"/icons/favicon.svg":"https://cdn-static-1.medium.com/_/fp/icons/favicon.KjTfUJo7yJH_fCoUzzH3cg.svg","/icons/favicon-dev-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-dev-editor.YKKRxBO8EMvIqhyCwIiJeQ.ico","/icons/favicon-hatch-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-hatch-editor.BuEyHIqlyh2s_XEk4Rl32Q.ico","/icons/favicon-medium-editor.ico":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium-editor.PiakrZWB7Yb80quUVQWM6g.ico"},"authBaseUrl":"https://medium.com","imageUploadSizeMb":25,"isAuthDomainRequest":true,"algoliaApiEndpoint":"https://MQ57UUUQZ2-dsn.algolia.net","algoliaAppId":"MQ57UUUQZ2","algoliaSearchOnlyApiKey":"394474ced050e3911ae2249ecc774921","iosAppStoreUrl":"https://itunes.apple.com/app/medium-everyones-stories/id828256236?pt=698524&mt=8","iosAppLinkBaseUrl":"medium:","algoliaIndexPrefix":"medium_","androidPlayStoreUrl":"https://play.google.com/store/apps/details?id=com.medium.reader","googleClientId":"216296035834-k1k6qe060s2tp2a2jam4ljdcms00sttg.apps.googleusercontent.com","androidPackage":"com.medium.reader","androidPlayStoreMarketScheme":"market://details?id=com.medium.reader","googleAuthUri":"https://accounts.google.com/o/oauth2/auth","androidScheme":"medium","layoutData":{"useDynamicScripts":false,"googleAnalyticsTrackingCode":"UA-24232453-2","jsShivUrl":"https://cdn-static-1.medium.com/_/fp/js/shiv.RI2ePTZ5gFmMgLzG5bEVAA.js","useDynamicCss":false,"faviconUrl":"https://cdn-static-1.medium.com/_/fp/icons/favicon-medium.TAS6uQ-Y7kcKgi0xjcYHXw.ico","faviconImageId":"1*W0nmth_X8nFKjn6BZ388UQ.png","fontSets":[{"id":1,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-base.by5Oi_VbnwEIvhnWIsuUjA.css"},{"id":4,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-base.g08Jj5TZPAiuPWj5YNUsSg.css"},{"id":6,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-latin-base.141WxxXgxGxNcfeza73H7Q.css"},{"id":7,"url":"https://cdn-static-1.medium.com/_/fp/css/fonts-lazy-latin-base.jMU532QDmysQMOINr-cr2A.css"}]},"authBaseUrlRev":"moc.muidem//:sptth","isDnt":true,"stripePublishableKey":"pk_live_7FReX44VnNIInZwrIIx6ghjl","archiveUploadSizeMb":100,"paymentData":{"currencies":{"1":{"label":"US Dollar","external":"usd"}},"countries":{"1":{"label":"United States of America","external":"US"}},"accountTypes":{"1":{"label":"Individual","external":"individual"},"2":{"label":"Company","external":"company"}}},"previewConfig2":{"weightThreshold":1,"weightImageParagraph":0.05,"raiseImage":true,"enforceHeaderHierarchy":true,"isImageInsetRight":true},"isAmp":false,"iosScheme":"medium","isSwBoot":false,"facebook":{"key":"542599432471018","secret":"c14df7146e9052a1131f3c900c1f0644","token":"542599432471018|1JqjIwxSfY9jOt_KwjWEl1R7T6I","namespace":"medium-com","scope":{"default":["public_profile","email","user_friends"],"connect":["public_profile","email","user_friends"],"login":["public_profile","email","user_friends"],"share":["public_profile","email","user_friends","publish_actions"]},"smartPublishWhitelistedPublications":["bcc38c8f6edf","f3726e2a5878","828a270689e","81c7d351c056","f30e42fd7ff8","8bf1d7d3081b","d16afa0ae7c","d8f3f6ad9c31","e74de0cedea9","15f753907972","c8c6a6b01ebd","3412b9729488","2ce4bbcf83bb","544c7006046e","7bfcdbc6b30a","a268fd916824","458a773bccd2"],"instantArticles":{"published":true,"developmentMode":false}},"mailingListArchiveUploadSizeMb":2,"availableMembershipPlans":[],"isDoNotAuth":false,"goldfinchUrl":"https://goldfinch.medium.com"}
// ]]></script><script charset="UTF-8" src="https://cdn-static-1.medium.com/_/fp/gen-js/main-base.bundle.G8dRKaC1ISGlp_vW2NEIXQ.js" async></script><script>// <![CDATA[
window["obvInit"]({"value":{"id":"da2a1e73a5f6","versionId":"8f21d0be150a","creatorId":"7db6d2df42a6","creator":{"userId":"7db6d2df42a6","name":"Kevin Beaumont","username":"networksecurity","createdAt":1394911388511,"lastPostCreatedAt":1489959778256,"imageId":"1*bAnzT3NFn-9L1xf_XWqzgA.jpeg","backgroundImageId":"1*5sy3Zmw6wjIcR33qaqzJbw.jpeg","bio":"IT Security, from the trenches of reality. Liverpool, UK based. Email kevin.beaumont@gmail.com | Twitter: @gossithedog on Twitter.","socialStats":{"userId":"7db6d2df42a6","usersFollowedCount":89,"usersFollowedByCount":744,"type":"SocialStats"},"social":{"userId":"lo_dnt_58749e281730","targetUserId":"7db6d2df42a6","type":"Social"},"allowNotes":1,"type":"User"},"homeCollectionId":"","title":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an…","detectedLanguage":"en","latestVersion":"8f21d0be150a","latestPublishedVersion":"8f21d0be150a","hasUnpublishedEdits":false,"latestRev":747,"createdAt":1489959778256,"updatedAt":1490042505452,"acceptedAt":0,"firstPublishedAt":1489967746180,"latestPublishedAt":1490042505452,"vote":false,"experimentalCss":"","displayAuthor":"","content":{"subtitle":"How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to…","bodyModel":{"paragraphs":[{"name":"127f","type":3,"text":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an organisation","markups":[]},{"name":"f58f","type":13,"text":"How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to defend against it.","markups":[]},{"name":"a559","type":4,"text":"Alexander Korznikov demonstrates using Sticky Keys and tscon to access an administrator RDP session — without even logging into the server.","markups":[],"layout":1,"metadata":{"id":"1*bd6ZhReKUzjJwunNpA6cDg.gif","originalWidth":480,"originalHeight":274}},{"name":"a625","type":13,"text":"Brief background on RDP session connection","markups":[]},{"name":"9669","type":1,"text":"If you’ve used Remote Desktop Services before, or Terminal Services if you’re as old as me, you will know there’s a feature where you connect to another user’s session — if you know their password. Did you know you can also hijack a session without the user password? Read on.","markups":[{"type":2,"start":170,"end":198}]},{"name":"c10c","type":1,"text":"You can right click a user in Task Manager, use tsadmin.msc, or use the command tscon.exe. It will ask for a password, and bomb if you can’t authenticate as the user:","markups":[]},{"name":"814f","type":4,"text":"","markups":[],"layout":1,"metadata":{"id":"1*Wr_SRDwI4hYKClcVKc0rrQ.png","originalWidth":1410,"originalHeight":579}},{"name":"a086","type":13,"text":"Some tricks allow credential-less Session Hijacking","markups":[]},{"name":"e7b4","type":1,"text":"Here’s the deal. As revealed by by Benjamin Delpy (of Mimikatz) in 2011 and by Alexander Korznikov on Friday, if you run tscon.exe as the SYSTEM user, you can connect to any session without a password. It doesn’t prompt, it just connects you to the user’s desktop. I believe this is due to the way session shadowing was implemented in Microsoft Windows, and it runs throughout the years like this.","markups":[{"type":3,"start":35,"end":49,"href":"http://blog.gentilkiwi.com/securite/vol-de-session-rdp","title":"","rel":"","anchorType":0},{"type":3,"start":79,"end":98,"href":"http://www.korznikov.com/2017/03/0-day-or-feature-privilege-escalation.html","title":"","rel":"","anchorType":0},{"type":1,"start":151,"end":200}]},{"name":"576b","type":1,"text":"Now, you might be saying ‘If you’re SYSTEM, you’re already root… You can already do anything’.","markups":[]},{"name":"b0e3","type":1,"text":"Yes. Yes you can. You could, for example, dump out the server memory and get user passwords. That’s a long process compared to just running tscon.exe with a session number, and instantly get the desktop of said user — with no obvious trace, or external tools. This isn’t about SYSTEM — this is about what you can do with it very quickly, and quietly. Attackers aren’t interested in playing, they’re interested in what they can do with techniques. This is a very valid technique.","markups":[]},{"name":"322b","type":1,"text":"So, you have full blown RDP session hijacking, with a single command.","markups":[]},{"name":"6400","type":13,"text":"Some parameters about how far this reaches","markups":[]},{"name":"a30f","type":9,"text":"You can connect to disconnected sessions. So if somebody logged out 3 days ago, you can just connect straight to their session and start using it.","markups":[]},{"name":"167a","type":9,"text":"It unlocks locked sessions. So if a user is away from their desk, you steal their session AND it unlocks the ‘workstation’ without needing any credentials.","markups":[]},{"name":"0193","type":9,"text":"It works for the physical console. So you can hijack the screen remotely. It also unlocks the physical console, too.","markups":[]},{"name":"99f5","type":9,"text":"You can connect to ANY session — so if, for example, it’s the Helpdesk, you can connect to it without any authentication. If it’s a Domain Admin, you’re in. Because of the above point (you can connect to disconnected sessions), this makes it an incredibly simple way to laterally move through a network.","markups":[]},{"name":"2544","type":9,"text":"You can use win32k SYSTEM exploits — there are many — to gain SYSTEM permissions, and then use this feature. Meaning even as a standard user, if patches aren’t applied properly you can use this. Obviously, any route to SYSTEM is valid — e.g. any method to get to a local administrator (there’s a few!).","markups":[{"type":3,"start":19,"end":34,"href":"https://arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/","title":"","rel":"","anchorType":0}]},{"name":"f4df","type":9,"text":"There are no external tools. Nothing to get through application whitelisting. No executable is written to disk.","markups":[]},{"name":"faf2","type":9,"text":"Unless you know what to monitor (more on that later), you won’t know this is happening.","markups":[]},{"name":"fb14","type":9,"text":"It works remotely. You can take over sessions on remote computers, even if you’re not logged into that server.","markups":[]},{"name":"e8fa","type":13,"text":"Gaining SYSTEM for tscon.exe","markups":[]},{"name":"7edc","type":1,"text":"If you’re an administrator, you can use a service as Alexander demonstrates:","markups":[]},{"name":"7e47","type":4,"text":"","markups":[],"layout":1,"metadata":{"id":"1*S5y5lGUCtZXvGQi7IpHpew.png","originalWidth":1231,"originalHeight":646}},{"name":"4dc7","type":1,"text":"In essence it is really easy, just use the quser command to get the Session ID you want to hijack, and your own SESSIONNAME. Then run tscon with the Session ID for hijack, and your own SESSIONNAME. Your own Session will be replaced with the hijacked session. The service will run as SYSTEM by default — you’re in.","markups":[]},{"name":"f815","type":1,"text":"Just remember to delete the service afterwards, if you’re evil.","markups":[]},{"name":"206e","type":1,"text":"Here’s an example of it in practice on a Windows Server 2012 R2 server:","markups":[]},{"name":"dd57","type":1,"text":"https://www.youtube.com/watch?v=OgsoIoWmhWw","markups":[{"type":3,"start":0,"end":43,"href":"https://www.youtube.com/watch?v=OgsoIoWmhWw","title":"","rel":"nofollow","anchorType":0}]},{"name":"34ea","type":1,"text":"Other methods:","markups":[]},{"name":"fa55","type":9,"text":"You can use Scheduled Tasks to gain SYSTEM and run the command. Just schedule the command to run immediately as SYSTEM with interactive privileges.","markups":[]},{"name":"e0fb","type":9,"text":"Use can use a variety of methods like Sticky Keys to get SYSTEM, without even needing to log in (in the future). See below.","markups":[]},{"name":"00cc","type":9,"text":"Exploits etc (see above).","markups":[]},{"name":"1dfb","type":13,"text":"Lateral movement","markups":[]},{"name":"6555","type":1,"text":"Most organisations allow Remote Desktop through their internal network, because it’s 2017 and that’s how Windows administration works. Also, RemoteApp uses RDP. Because of this, it’s a fantastic way to move around an organisation’s network — forget passwords, just surf around and abuse other people’s access. You appear in the organisation logs as that user, not yourself.","markups":[]},{"name":"875d","type":13,"text":"How to backdoor for credential-less hijacking","markups":[]},{"name":"652e","type":1,"text":"Remote Desktop bruteforcing is a major problem. Anybody who has setup a honeypot recently will know within seconds you will be getting hit with failed RDP logins. First they portscan, then thousands of login attempts arrive.","markups":[]},{"name":"ea52","type":1,"text":"It gets worse — I run RDP honeypots, and I see them regularly — when breached they get backdoored using the techniques below.","markups":[]},{"name":"3547","type":1,"text":"From research, over 1 in 200 scanned Remote Desktop servers online are already backdoored using these methods. This means that you can session hijack with them right now, without even needing to try to log in or authenticate in any way. That’s bad. Consider Shodan shows there are millions of RDP servers online right now, and the number grows constantly with cloud services etc, this is going to generate… issues.","markups":[]},{"name":"b6c3","type":13,"text":"RDP backdoor method one — Sticky Keys","markups":[]},{"name":"c755","type":1,"text":"The concept here is pretty simple — Windows supports a feature called Sticky Keys, which is an Accessibility feature built into the OS and available pre-logon (at the login screen, either via a physical console or via Remote Desktop). It runs as SYSTEM.","markups":[]},{"name":"57df","type":1,"text":"If you set Sethc.exe (Sticky Keys) to spawn cmd.exe, you have a backdoor you can use if you are locked out of a box — you have SYSTEM access, so you can do anything even without an account. You can do this by either replacing sethc.exe with cmd.exe — this requires a reboot, and physical access to the box — or just set the registry key using the command below.","markups":[]},{"name":"139b","type":8,"text":"REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\sethc.exe\" /t REG_SZ /v Debugger /d “C:\\windows\\system32\\cmd.exe” /f","markups":[]},{"name":"e4ab","type":1,"text":"Ta-da! The box is now permanently backdoored. Just Remote Desktop in and at the login screen, hit F5 a bunch of times.","markups":[]},{"name":"d16d","type":13,"text":"Method two — Utilman","markups":[]},{"name":"06e4","type":1,"text":"It’s exactly the same as before, just trojan utilman.exe instead. At the login screen, press Windows Key+U, and you get a cmd.exe window as SYSTEM.","markups":[]},{"name":"7442","type":8,"text":"REG ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\utilman.exe\" /t REG_SZ /v Debugger /d “C:\\windows\\system32\\cmd.exe” /f","markups":[]},{"name":"c067","type":13,"text":"Scanning for backdoor’d RDP servers","markups":[]},{"name":"cc64","type":1,"text":"There is a prebuilt tool here, which works wonders — just spin it up and find servers which already have a SYSTEM level backdoor exposed:","markups":[]},{"name":"4f16","type":14,"text":"ztgrace/sticky_keys_hunter\nsticky_keys_hunter - A script to test an RDP host for sticky keys and utilman backdoor.github.com","markups":[{"type":3,"start":0,"end":124,"href":"https://github.com/ztgrace/sticky_keys_hunter","title":"https://github.com/ztgrace/sticky_keys_hunter","rel":"","anchorType":0},{"type":1,"start":0,"end":26},{"type":2,"start":27,"end":114}],"mixtapeMetadata":{"mediaResourceId":"7a743010bb8152949a3ee889bdd38a04","thumbnailImageId":"0*UEsyEzNqcXOl_9ih.","href":"https://github.com/ztgrace/sticky_keys_hunter"}},{"name":"ff6c","type":1,"text":"From online scanning, a significant amount of open RDP servers online are already backdoored.","markups":[]},{"name":"a5b4","type":13,"text":"Mimikatz module","markups":[]},{"name":"aeeb","type":1,"text":"There is now a Mimikatz module for very easily doing this:","markups":[]},{"name":"b09b","type":14,"text":"gentilkiwi/mimikatz\nmimikatz - A little tool to play with Windows securitygithub.com","markups":[{"type":3,"start":0,"end":84,"href":"https://github.com/gentilkiwi/mimikatz/releases","title":"https://github.com/gentilkiwi/mimikatz/releases","rel":"","anchorType":0},{"type":1,"start":0,"end":19},{"type":2,"start":20,"end":74}],"mixtapeMetadata":{"mediaResourceId":"35f337436609fd741f52628740d9e66f","thumbnailImageId":"0*vEmdb17TmcRb5Tqo.","href":"https://github.com/gentilkiwi/mimikatz/releases"}},{"name":"bf82","type":4,"text":"gentilkiwi rocking it","markups":[],"layout":1,"metadata":{"id":"1*oFF3A3KhTzGrEnS_3vV36g.gif","originalWidth":600,"originalHeight":387}},{"name":"db3c","type":13,"text":"Mitigations","markups":[]},{"name":"e444","type":1,"text":"OS-I had a section about Window Server 2016 here, however after further investigation it appears to also be impacted. After testing this applies to every OS since Windows 2000, including Windows 10 and 2016.","markups":[{"type":1,"start":0,"end":2,"href":"","title":"","rel":"","name":"","anchorType":0,"creatorIds":[],"userId":""}]},{"name":"6ea7","type":1,"text":"Group Policy — I strongly recommend you use Group Policy to log off disconnected sessions, either immediately or soon after the user disconnects. This will NOT be popular in IT environments — but the risk is now completely real that they can very easily — with one built in command — be hijacked more or less silently in the real world. I would also log off idle sessions.","markups":[{"type":1,"start":0,"end":13}]},{"name":"ec3c","type":1,"text":"Don’t expose RDS/RDP to the internet — if you do, I strongly suggest you implement multi-factor authentication. You can use things like Microsoft RD Gateway or Azure Multi-Factor Authentication Server to get very low cost multi-factor authentication. If you’re exposing RDP directly to the internet and somebody creates a local user or your domain users have easy to guess or reused credentials, things will go downhill fast. Trust me — I’ve seen hospitals and others be ransomware’d by RDS servers.","markups":[{"type":1,"start":0,"end":37},{"type":1,"start":52,"end":69},{"type":2,"start":52,"end":69}]},{"name":"1479","type":13,"text":"Monitoring","markups":[]},{"name":"c6da","type":1,"text":"It is surprisingly very difficult to record session hijacking — there is one event log (Microsoft-Windows-TerminalServices-LocalSessionManager/Operational) which records sessions connecting — however it does not appear to differentiate between a normal user connecting and tscon.exe being used — I’ve been through every other event log and can’t see anything which suggests this is happening. This is actually a major issue and I lobby Microsoft to add some kind of Event Log ASAP — it’s a real gap.","markups":[]},{"name":"495e","type":1,"text":"My suggestion is you alert for other related behaviour using the Event Log and tools like Microsoft OMS, Windows Event Forwarding, Splunk etc. You’re looking for SYSTEM being misused.","markups":[]},{"name":"f98b","type":1,"text":"For example abnormal Service creation and abnormal scheduled task creation should be logged centrally, and recorded against. Additionally, you can look for Mimikatz related activity.","markups":[]},{"name":"78e4","type":9,"text":"k","markups":[]},{"name":"5fd2","type":13,"text":"FAQ","markups":[]},{"name":"6aca","type":1,"text":"Q: This isn’t new or a vulnerability.","markups":[]},{"name":"7825","type":1,"text":"A: Java applets and macros aren’t new. If the technique works, it will get used. This one has flown under the radar — that doesn’t mean it is not valid.","markups":[]},{"name":"9a4f","type":1,"text":"Q: If you have SYSTEM you already own the box.","markups":[]},{"name":"e25f","type":1,"text":"A: Correct. Can you type one command and get the unlocked desktop of a user, even if they went on holiday a week ago, without a log of it? Now you can.","markups":[]}],"sections":[{"name":"adb2","startIndex":0}]},"postDisplay":{"coverless":true}},"virtuals":{"allowNotes":true,"previewImage":{"imageId":"1*bd6ZhReKUzjJwunNpA6cDg.gif","filter":"","backgroundSize":"","originalWidth":480,"originalHeight":274,"strategy":"resample","height":0,"width":0},"wordCount":1592,"imageCount":4,"readingTime":6.707547169811321,"subtitle":"How you can very easily use Remote Desktop Services to gain lateral movement through a network, using no external software — and how to…","usersBySocialRecommends":[],"recommends":21,"socialRecommends":[],"isBookmarked":false,"tags":[{"slug":"microsoft","name":"Microsoft","postCount":10597,"virtuals":{"isFollowing":false},"metadata":{"followerCount":959,"postCount":10597,"coverImage":{"id":"1*O35VAE34NJLw0QZVbbeNZA.png","originalWidth":665,"originalHeight":460,"isFeatured":true,"focusPercentX":74,"focusPercentY":32}},"type":"Tag"},{"slug":"sysadmin","name":"Sysadmin","postCount":483,"virtuals":{"isFollowing":false},"metadata":{"followerCount":105,"postCount":483,"coverImage":{"id":"1*bd6ZhReKUzjJwunNpA6cDg.gif","originalWidth":480,"originalHeight":274}},"type":"Tag"},{"slug":"rds","name":"Rds","postCount":31,"virtuals":{"isFollowing":false},"metadata":{"followerCount":1,"postCount":31,"coverImage":{"id":"1*bd6ZhReKUzjJwunNpA6cDg.gif","originalWidth":480,"originalHeight":274}},"type":"Tag"},{"slug":"hijack","name":"Hijack","postCount":9,"virtuals":{"isFollowing":false},"metadata":{"followerCount":0,"postCount":9,"coverImage":{"id":"1*bd6ZhReKUzjJwunNpA6cDg.gif","originalWidth":480,"originalHeight":274}},"type":"Tag"}],"socialRecommendsCount":0,"responsesCreatedCount":0,"links":{"entries":[{"url":"https://www.youtube.com/watch?v=OgsoIoWmhWw","alts":[{"type":2,"url":"vnd.youtube://www.youtube.com/watch?v=OgsoIoWmhWw&feature=applinks"},{"type":3,"url":"vnd.youtube://www.youtube.com/watch?v=OgsoIoWmhWw&feature=applinks"}]},{"url":"https://arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/","alts":[{"type":1,"url":"https://cdn.ampproject.org/c/s/arstechnica.co.uk/security/2016/11/trick-or-treat-google-issues-warning-of-critical-windows-vulnerability/?amp=1"}]}],"version":"0.3","generatedAt":1490042506546},"isLockedPreviewOnly":false,"takeoverId":"","metaDescription":"","totalClapCount":0},"coverless":true,"slug":"rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an","translationSourcePostId":"","translationSourceCreatorId":"","isApprovedTranslation":false,"inResponseToPostId":"","inResponseToRemovedAt":0,"isTitleSynthesized":true,"allowResponses":true,"importedUrl":"","importedPublishedAt":0,"visibility":0,"uniqueSlug":"rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6","previewContent":{"bodyModel":{"paragraphs":[{"name":"127f","type":3,"text":"RDP hijacking — how to hijack RDS and RemoteApp sessions transparently to move through an organisation","markups":[],"alignment":1},{"name":"f58f","type":13,"text":"How you can very easily use Remote Desktop Services to gain lateral movement through a network, using…","markups":[],"alignment":1}],"sections":[{"startIndex":0}]},"isFullContent":false},"license":0,"inResponseToMediaResourceId":"","canonicalUrl":"https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6","approvedHomeCollectionId":"","newsletterId":"","webCanonicalUrl":"https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6","mediumUrl":"https://medium.com/@networksecurity/rdp-hijacking-how-to-hijack-rds-and-remoteapp-sessions-transparently-to-move-through-an-da2a1e73a5f6","migrationId":"","notifyFollowers":true,"notifyTwitter":true,"isSponsored":false,"isRequestToPubDisabled":false,"notifyFacebook":false,"responseHiddenOnParentPostAt":0,"isSeries":false,"isSubscriptionLocked":false,"seriesLastAppendedAt":0,"type":"Post"},"mentionedUsers":[],"collaborators":[],"membershipPlans":[],"collectionUserRelations":[],"mode":null,"references":{"User":{"7db6d2df42a6":{"userId":"7db6d2df42a6","name":"Kevin Beaumont","username":"networksecurity","createdAt":1394911388511,"lastPostCreatedAt":1489959778256,"imageId":"1*bAnzT3NFn-9L1xf_XWqzgA.jpeg","backgroundImageId":"1*5sy3Zmw6wjIcR33qaqzJbw.jpeg","bio":"IT Security, from the trenches of reality. Liverpool, UK based. Email kevin.beaumont@gmail.com | Twitter: @gossithedog on Twitter.","socialStats":{"userId":"7db6d2df42a6","usersFollowedCount":89,"usersFollowedByCount":744,"type":"SocialStats"},"social":{"userId":"lo_dnt_58749e281730","targetUserId":"7db6d2df42a6","type":"Social"},"allowNotes":1,"type":"User"}},"Social":{"7db6d2df42a6":{"userId":"lo_dnt_58749e281730","targetUserId":"7db6d2df42a6","type":"Social"}},"SocialStats":{"7db6d2df42a6":{"userId":"7db6d2df42a6","usersFollowedCount":89,"usersFollowedByCount":744,"type":"SocialStats"}}}})
// ]]></script></body></html>