<!doctype html>
<html amp lang="ru-RU">

<!-- Mirrored from movaxbx.ru/2018/06/13/windows-ntfs-tricks-collection/amp/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Jun 2018 09:19:48 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
	
<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="MOV AX, BX Code depilation salon: Articles, Code samples, Processor code documentation, Low-level programming, Working with debuggers WINDOWS NTFS TRICKS COLLECTION" />
<meta property="og:url" content="../index.html" />
<meta property="og:description" content="TRICK 1: CREATE FOLDERS WITHOUT PERMISSIONS (CVE-2018-1036/NTFS EOP) On Windows you can assign “special permissions” to folders like permissions that a user is allowed to create files in a folder, …" />
<meta property="article:published_time" content="2018-06-13T08:45:56+00:00" />
<meta property="article:modified_time" content="2018-06-13T08:45:56+00:00" />
<meta property="og:site_name" content="MOV AX, BX" />
<meta property="og:image" content="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-25.png" />
<meta property="og:image:width" content="351" />
<meta property="og:image:height" content="268" />
<meta property="og:locale" content="ru_RU" />
<meta name="twitter:text:title" content="WINDOWS NTFS TRICKS COLLECTION" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="@OxFemale" />

<!-- End Jetpack Open Graph Tags -->
	<title>MOV AX, BX Code depilation salon: Articles, Code samples, Processor code documentation, Low-level programming, Working with debuggers WINDOWS NTFS TRICKS COLLECTION</title>
		<link rel="canonical" href="../index.html" />
	<script type='text/javascript' src='https://cdn.ampproject.org/v0.js' async></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic"><style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>	<script type="application/ld+json">{"@context":"http:\/\/schema.org","publisher":{"@type":"Organization","name":"MOV AX, BX","logo":{"@type":"ImageObject","url":"https:\/\/movaxbx.ru\/wp-content\/uploads\/2016\/12\/cropped-Gekitou_Car_Battler_Go_J_GBA_Debug-1-32x32.png","height":32,"width":32}},"@type":"BlogPosting","mainEntityOfPage":"https:\/\/movaxbx.ru\/2018\/06\/13\/windows-ntfs-tricks-collection\/","headline":"WINDOWS NTFS TRICKS COLLECTION","datePublished":"2018-06-13T11:45:56+00:00","dateModified":"2018-06-13T11:45:56+00:00","author":{"@type":"Person","name":"movaxbx"},"image":{"@type":"ImageObject","url":"https:\/\/sec-consult.com\/wp-content\/uploads\/2018\/06\/pentesting-ntfs-1.png","width":1372,"height":622}}</script>
	<meta name="generator" content="AMP Plugin v0.7.1" />	<style amp-custom>
		/* Generic WP styling */

.alignright {
	float: right;
}

.alignleft {
	float: left;
}

.aligncenter {
	display: block;
	margin-left: auto;
	margin-right: auto;
}

.amp-wp-enforced-sizes {
	/** Our sizes fallback is 100vw, and we have a padding on the container; the max-width here prevents the element from overflowing. **/
	max-width: 100%;
	margin: 0 auto;
}

.amp-wp-unknown-size img {
	/** Worst case scenario when we can't figure out dimensions for an image. **/
	/** Force the image into a box of fixed dimensions and use object-fit to scale. **/
	object-fit: contain;
}

/* Template Styles */

.amp-wp-content,
.amp-wp-title-bar div {
		margin: 0 auto;
	max-width: 525px;
	}

html {
	background: #0a89c0;
}

body {
	background: #fff;
	color: #353535;
	font-family: 'Merriweather', 'Times New Roman', Times, Serif;
	font-weight: 300;
	line-height: 1.75em;
}

p,
ol,
ul,
figure {
	margin: 0 0 1em;
	padding: 0;
}

a,
a:visited {
	color: #0a89c0;
}

a:hover,
a:active,
a:focus {
	color: #353535;
}

/* Quotes */

blockquote {
	color: #353535;
	background: rgba(127,127,127,.125);
	border-left: 2px solid #0a89c0;
	margin: 8px 0 24px 0;
	padding: 16px;
}

blockquote p:last-child {
	margin-bottom: 0;
}

/* UI Fonts */

.amp-wp-meta,
.amp-wp-header div,
.amp-wp-title,
.wp-caption-text,
.amp-wp-tax-category,
.amp-wp-tax-tag,
.amp-wp-comments-link,
.amp-wp-footer p,
.back-to-top {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen-Sans", "Ubuntu", "Cantarell", "Helvetica Neue", sans-serif;
}

/* Header */

.amp-wp-header {
	background-color: #0a89c0;
}

.amp-wp-header div {
	color: #fff;
	font-size: 1em;
	font-weight: 400;
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: .875em 16px;
	position: relative;
}

.amp-wp-header a {
	color: #fff;
	text-decoration: none;
}

/* Site Icon */

.amp-wp-header .amp-wp-site-icon {
	/** site icon is 32px **/
	background-color: #fff;
	border: 1px solid #fff;
	border-radius: 50%;
	position: absolute;
	right: 18px;
	top: 10px;
}

/* Article */

.amp-wp-article {
	color: #353535;
	font-weight: 400;
	margin: 1.5em auto;
	max-width: 840px;
	overflow-wrap: break-word;
	word-wrap: break-word;
}

/* Article Header */

.amp-wp-article-header {
	align-items: center;
	align-content: stretch;
	display: flex;
	flex-wrap: wrap;
	justify-content: space-between;
	margin: 1.5em 16px 0;
}

.amp-wp-title {
	color: #353535;
	display: block;
	flex: 1 0 100%;
	font-weight: 900;
	margin: 0 0 .625em;
	width: 100%;
}

/* Article Meta */

.amp-wp-meta {
	color: #696969;
	display: inline-block;
	flex: 2 1 50%;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0 0 1.5em;
	padding: 0;
}

.amp-wp-article-header .amp-wp-meta:last-of-type {
	text-align: right;
}

.amp-wp-article-header .amp-wp-meta:first-of-type {
	text-align: left;
}

.amp-wp-byline amp-img,
.amp-wp-byline .amp-wp-author {
	display: inline-block;
	vertical-align: middle;
}

.amp-wp-byline amp-img {
	border: 1px solid #0a89c0;
	border-radius: 50%;
	position: relative;
	margin-right: 6px;
}

.amp-wp-posted-on {
	text-align: right;
}

/* Featured image */

.amp-wp-article-featured-image {
	margin: 0 0 1em;
}
.amp-wp-article-featured-image amp-img {
	margin: 0 auto;
}
.amp-wp-article-featured-image.wp-caption .wp-caption-text {
	margin: 0 18px;
}

/* Article Content */

.amp-wp-article-content {
	margin: 0 16px;
}

.amp-wp-article-content ul,
.amp-wp-article-content ol {
	margin-left: 1em;
}

.amp-wp-article-content amp-img {
	margin: 0 auto;
}

.amp-wp-article-content amp-img.alignright {
	margin: 0 0 1em 16px;
}

.amp-wp-article-content amp-img.alignleft {
	margin: 0 16px 1em 0;
}

/* Captions */

.wp-caption {
	padding: 0;
}

.wp-caption.alignleft {
	margin-right: 16px;
}

.wp-caption.alignright {
	margin-left: 16px;
}

.wp-caption .wp-caption-text {
	border-bottom: 1px solid #c2c2c2;
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 0;
	padding: .66em 10px .75em;
}

/* AMP Media */

amp-carousel {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}
amp-iframe,
amp-youtube,
amp-instagram,
amp-vine {
	background: #c2c2c2;
	margin: 0 -16px 1.5em;
}

.amp-wp-article-content amp-carousel amp-img {
	border: none;
}

amp-carousel > amp-img > img {
	object-fit: contain;
}

.amp-wp-iframe-placeholder {
	background: #c2c2c2 url( https://movaxbx.ru/wp-content/plugins/amp/assets/images/placeholder-icon.png) no-repeat center 40%;
	background-size: 48px 48px;
	min-height: 48px;
}

/* Article Footer Meta */

.amp-wp-article-footer .amp-wp-meta {
	display: block;
}

.amp-wp-tax-category,
.amp-wp-tax-tag {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	margin: 1.5em 16px;
}

.amp-wp-comments-link {
	color: #696969;
	font-size: .875em;
	line-height: 1.5em;
	text-align: center;
	margin: 2.25em 0 1.5em;
}

.amp-wp-comments-link a {
	border-style: solid;
	border-color: #c2c2c2;
	border-width: 1px 1px 2px;
	border-radius: 4px;
	background-color: transparent;
	color: #0a89c0;
	cursor: pointer;
	display: block;
	font-size: 14px;
	font-weight: 600;
	line-height: 18px;
	margin: 0 auto;
	max-width: 200px;
	padding: 11px 16px;
	text-decoration: none;
	width: 50%;
	-webkit-transition: background-color 0.2s ease;
			transition: background-color 0.2s ease;
}

/* AMP Footer */

.amp-wp-footer {
	border-top: 1px solid #c2c2c2;
	margin: calc(1.5em - 1px) 0 0;
}

.amp-wp-footer div {
	margin: 0 auto;
	max-width: calc(840px - 32px);
	padding: 1.25em 16px 1.25em;
	position: relative;
}

.amp-wp-footer h2 {
	font-size: 1em;
	line-height: 1.375em;
	margin: 0 0 .5em;
}

.amp-wp-footer p {
	color: #696969;
	font-size: .8em;
	line-height: 1.5em;
	margin: 0 85px 0 0;
}

.amp-wp-footer a {
	text-decoration: none;
}

.back-to-top {
	bottom: 1.275em;
	font-size: .8em;
	font-weight: 600;
	line-height: 2em;
	position: absolute;
	right: 16px;
}
		/* Inline styles */
.amp-wp-inline-7fa7ca514182911e897d64c2e584975d{max-width:1372px;}.amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df{max-width:450px;}.amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8{max-width:600px;}.amp-wp-inline-a934f5063b536a3ced66a8b496a4571d{max-width:412px;}.amp-wp-inline-ce22db4bd4f2f83287e6658251942bf6{max-width:406px;}.amp-wp-inline-71911977dbbb25071d1f5937912cb91f{max-width:1116px;}.amp-wp-inline-2dea000bb738a8c6fa4924f9e6a686a7{max-width:409px;}.amp-wp-inline-9fd1aac1623b40483103f6b1f57086da{max-width:430px;}.amp-wp-inline-9bafa402f4f82e00431e970948b4d179{max-width:696px;}.amp-wp-inline-5c2ffdd18592dbc587ec3184c4bd0d75{max-width:1087px;}.amp-wp-inline-1ba349842782125155a70159a7111420{max-width:351px;}	</style>
</head>

<body class="">

<header id="top" class="amp-wp-header">
	<div>
		<a href="https://movaxbx.ru/">
										<amp-img src="https://movaxbx.ru/wp-content/uploads/2016/12/cropped-Gekitou_Car_Battler_Go_J_GBA_Debug-1-32x32.png" width="32" height="32" class="amp-wp-site-icon"></amp-img>
						<span class="amp-site-title">
				MOV AX, BX			</span>
		</a>
	</div>
</header>

<article class="amp-wp-article">
	<header class="amp-wp-article-header">
		<h1 class="amp-wp-title">WINDOWS NTFS TRICKS COLLECTION</h1>
			<div class="amp-wp-meta amp-wp-byline">
					<amp-img src="https://secure.gravatar.com/avatar/e9665cf039c6b5ff16c2ec936c88f7b7?s=24&amp;d=retro&amp;r=g" width="24" height="24" layout="fixed"></amp-img>
				<span class="amp-wp-author author vcard">movaxbx</span>
	</div>
<div class="amp-wp-meta amp-wp-posted-on">
	<time datetime="2018-06-13T11:45:56+00:00">
		1 день ago	</time>
</div>
	</header>

	
	<div class="amp-wp-article-content">
		<h2><strong>TRICK 1: CREATE FOLDERS WITHOUT PERMISSIONS (CVE-2018-1036/NTFS EOP)</strong></h2><p>On Windows you can assign “special permissions” to folders like permissions that a user is allowed to create files in a folder, but is not allowed to create folders.</p><p>One example of such a folder is C:\Windows\Tasks\ where users can create files, but are not allowed to create folders:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-1.png" width="1372" height="622" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-7fa7ca514182911e897d64c2e584975d"><amp-img class="size-full wp-image-6763  amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-1.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-1.png 1372w, /wp-content/uploads/2018/06/pentesting-ntfs-1-300x136.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-1-1024x464.png 1024w, /wp-content/uploads/2018/06/pentesting-ntfs-1-300x136@2x.png 600w" alt="" width="1372" height="622" layout="intrinsic"></amp-img></figure></p><p>Moreover, it’s possible that an administrator or a program configures such permissions and assumes that users are really not allowed to create folders in it.</p><p>This ACL can be bypassed as soon as a user can create files. Adding “::$INDEX_ALLOCATION” to the end of a filename will create a folder instead of a file and Windows currently doesn’t include a check for this corner case.</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-2.png" width="604" height="469" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6764 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-2.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-2.png 604w, /wp-content/uploads/2018/06/pentesting-ntfs-2-300x233.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-2-300x233@2x.png 600w" alt="" width="450" height="349" layout="intrinsic"></amp-img></figure></p><p>As shown above, a directory was successfully created and the user can create arbitrary files or folders in this directory (which can lead to privilege escalation if an administrator/program assumes that this is not possible because of the missing permissions).</p><p>Side note: The ::$INDEX_ALLOCATION trick can also be used to delete directories if an application just allows to delete files.</p><h3>Contact timeline:</h3><p> </p><table class="secTable" role="grid"><tbody>
<tr role="row">
<td width="80px">2018-03-01:</td>
<td>Initial contact via secure@microsoft.com. Sending PGP encrypted blogpost.</td>
</tr>
<tr>
<td>2018-03-01:</td>
<td>Microsoft assigned MSRC Case 43968 CRM:0461039882</td>
</tr>
<tr>
<td>2018-03-05:</td>
<td>Microsoft asks to extend the disclosure deadline.</td>
</tr>
<tr>
<td>2018-03-05:</td>
<td>Agreed upon the extended 90 days deadline.</td>
</tr>
<tr>
<td>2018-03-27:</td>
<td>Asked Microsoft if the vulnerabilities could be reproduced and when a patch will be available.</td>
</tr>
<tr>
<td>2018-03-28:</td>
<td>Microsoft confirmed that the “trick 1” vulnerability was successfully reproduced and assigned CVE-2018-1036. The vulnerability will be fixed by 5B (May Patch Tuesday).</td>
</tr>
<tr>
<td>2018-04-27:</td>
<td>Microsoft contacted us that the proposed fix lead to a regression. Microsoft asked to extend the deadline to 2018-06-12 (June Patch Tuesday).</td>
</tr>
<tr>
<td>2018-04-30:</td>
<td>Informed Microsoft that the deadline gets extended to 2018-06-12. Asked Microsoft if the other tricks will also be patched.</td>
</tr>
<tr>
<td>2018-04-30:</td>
<td>Microsoft responded that the other tricks “will not receive a downlevel security update”.</td>
</tr>
<tr>
<td>2018-06-12:</td>
<td>Microsoft releases the patch (see <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2018-1036"><u>release here</u></a>)</td>
</tr>
<tr>
<td>2018-06-13:</td>
<td>Blog post release.</td>
</tr>
</tbody></table>
<p> </p><h2><strong>TRICK 2: BYPASS PATH RESTRICTIONS WITH ALTERNATE DATA STREAMS</strong></h2><p>You maybe wonder why the above technique worked. Basically files on a NTFS volume are stored in the form:</p><p>&lt;filename&gt;:&lt;stream-name&gt;:&lt;type&gt;</p><p>If we create a file named test.txt it will internally be stored as test.txt::$DATA because the stream name is empty and $DATA is the default type. The first trick abused the fact that the type can be changed to INDEX_ALLOCATION which corresponds to the directory type and therefore creates a directory.</p><p>However, it’s also possible to store data in a different stream (then this is called Alternate Data Stream – ADS). If we write for example to “test.txt”, we write in reality to “test.txt::$DATA” (the stream name is empty). However, we can also write to “test.txt:foo” or to “test.txt:foo:$DATA” (both are equal because $DATA is the default type). Different stream names are for example used to store the origin of a file. If you download a file from the internet (or receive it via e-mail), Windows silently adds a Zone Identifier via a stream name (then it can show an additional warning dialog if you want to execute it). For example, if we download “putty.exe”, Windows also creates “putty.exe:Zone.Identifier:$DATA”. These stream names can be made visible via the /r switch with the dir command:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-24.png" width="894" height="509" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6780 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-24.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-24.png 894w, /wp-content/uploads/2018/06/pentesting-ntfs-24-300x171.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-24-300x171@2x.png 600w" alt="" width="600" height="342" layout="intrinsic"></amp-img></figure></p><p>As you can see, the Zone Identifier can’t be read via the type command (with the more command it would work) and it’s also important to omit the $DATA type if we read the file with notepad. The important message is that we can store data in an ADS (including applications!). For example, putty can be copied to an ADS and then be invoked via wmic (direct invocation is not possible):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-20.png" width="902" height="305" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6776 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-20.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-20.png 902w, /wp-content/uploads/2018/06/pentesting-ntfs-20-300x101.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-20-300x101@2x.png 600w" alt="" width="600" height="203" layout="intrinsic"></amp-img></figure></p><p>Side note: This article was written on 2018-03-01 and reported to Microsoft. In the meantime Microsoft Windows Defender was updated to detect WMIC process invocations.</p><p>You maybe ask yourself why someone would do this? First of all, ADS can be used to hide data (dir command without the /r switch will not display them; explorer.exe will also not show them; We will later see how we can even hide from the /r dir switch…). However, ADS has another great property – we can add an ADS to a folder. To be allowed to do this we must own the “create folders” permissions on the directory (and the folder name must not be a number). The important fact is that an ADS on a folder looks like a file from the parent folder!</p><p>For example, on Windows a normal user can’t create files in C:\Windows\ (only admins can write to this folder). So it’s possible that applications assume that files in C:\Windows\ can be trusted because only admins can create such files. However, C:\Windows\Tracing is a folder in which normal users can create files and folders – a normal user can therefore create an ADS on this folder.</p><p>Let’s say the user writes to the file C:\Windows\Tracing:test.dll. If this path is now passed to a Windows API which calculates the base folder, this API will start at the end of the path and go backward until the first “\” is found. Then everything left from “\” will be returned as the base folder. For C:\Windows\Tracing:test.dll this will return C:\Windows\ as base folder, however, as already mentioned, a normal user is not allowed to create files in this folder but using this trick we created a file which looks like it is stored in C:\Windows!</p><p>Here is the output of different Windows functions which calculate the base folder (we can see that it’s always C:\windows):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-21.png" width="642" height="277" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6777 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-21.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-21.png 642w, /wp-content/uploads/2018/06/pentesting-ntfs-21-300x129.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-21-300x129@2x.png 600w" alt="" width="450" height="194" layout="intrinsic"></amp-img></figure></p><p>Side note: The above stored dll can be started with the Windows built-in control.exe application with the command: control.exe C:\Windows\tracing:foobar.dll</p><p>This behavior can be used to bypass some application whitelisting solutions but can also bypass security checks in various situations where the programmer assumed that it’s enough to check if a file is stored in a specific base folder and assumes that only admins can write to this folder because of the set ACL.</p><p>For example, consider that an application allows to upload data and that uploaded data is stored in applicationFolder\uploadedData\. Moreover, the application allows to start scripts / applications from applicationFolder\ but not from applicationFolder\uploadedData\ (with a blacklist approach). If the user uploads a file named “:foo.ps1″, the system will create an ADS like applicationFolder\uploadedData:foo.ps1 and this file appears to be stored inside applicationFolder\ and therefore bypassing the security checks.</p><p>Another interesting fact is that ADS names can contain symbols which are normally forbidden for filenames like ” or * (you have to create these files using the native Windows API; cmd.exe filteres these characters):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-33.png" width="619" height="314" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6785 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-33.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-33.png 619w, /wp-content/uploads/2018/06/pentesting-ntfs-33-300x152.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-33-300x152@2x.png 600w" alt="" width="450" height="228" layout="intrinsic"></amp-img></figure></p><p>This on it’s own can lead to several problems (e.g.: if the filename ends with ” and the path is enclosed by ” as mentioned by James Forshaw in his blog; see the references section). However, another interesting attack vector can be XSS (or command injection). Let’s assume that a website runs on IIS and allows to upload files and is prone to CSRF. After uploading the file a success dialog is shown including the filename. If the filename is not sanitized, this could lead to XSS, however, filenames are not allowed to contain symbols such as &lt; or &gt; (and we can therefore not execute JavaScript code with it). However, an ADS is allowed to contain these symbols, therefore an attacker could try to send an upload request for a filename with ADS:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-55.png" width="1067" height="293" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6793  amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-55.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-55.png 1067w, /wp-content/uploads/2018/06/pentesting-ntfs-55-300x82.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-55-1024x281.png 1024w, /wp-content/uploads/2018/06/pentesting-ntfs-55-300x82@2x.png 600w" alt="" width="600" height="165" layout="intrinsic"></amp-img></figure></p><h2><strong>TRICK 3: CREATE FILES WHICH CAN’T BE FOUND BY USING THE “…” FOLDER</strong></h2><p>Every folder contains per default two special entries, namely the directory “.” which refers to the current directory and “..” which referes to the parent directory. On Windows it’s not possible to create files / folders with just dots in the name, most likely to prevent attacks which confuse the parsers with the dots.</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-5.png" width="520" height="300" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6767 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-5.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-5.png 520w, /wp-content/uploads/2018/06/pentesting-ntfs-5-300x173.png 300w" alt="" width="450" height="260" layout="intrinsic"></amp-img></figure></p><p>The screenshot above shows that it’s not possible to create a “…” or “….” folder. However, this can be bypassed with the above mentioned ::$INDEX_ALLOCATION trick:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-6.png" width="412" height="279" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-a934f5063b536a3ced66a8b496a4571d"><amp-img class="wp-image-6768 size-full amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-6.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-6.png 412w, /wp-content/uploads/2018/06/pentesting-ntfs-6-300x203.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-6-400x270.png 400w" alt="" width="412" height="279" layout="intrinsic"></amp-img></figure></p><p>The “…” folder was created with the above mentioned trick, however, such folders can also be created by passing the name twice as shown in the “….” example (mkdir “….\….\” creates the directory “….”, but also a directory “….” in it. Just passing mkdir “….\xyz\” doesn’t work.).</p><p>Using the second trick you can also enter these folders, store files there or even execute programs from this location:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-7.png" width="406" height="468" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-ce22db4bd4f2f83287e6658251942bf6"><amp-img class="wp-image-6769 size-full amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-7.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-7.png 406w, /wp-content/uploads/2018/06/pentesting-ntfs-7-260x300.png 260w" alt="" width="406" height="468" layout="intrinsic"></amp-img></figure></p><p>As you can see, you can’t enter the folder with just the name (e.g.: “cd …” or “cd …\” or “cd …\…” is not working), so you really have to use the syntax “cd …\…\”. After that you can create files in this folder. (Interesting side note: If you enter “cd .” in this folder, you will go one directory up, because path’s are confused).</p><p>Moreover, it’s also not possible to open this directory from the GUI (explorer.exe). I encountered two different situations. In some cases double clicking such a folder has no impact (you stay in the current directory and the path keeps the same), in other cases you stay in the folder but the path in the explorer changes. For example, after “opening” the folder 17 times it looks like this (notice the “…” dirs in the path):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-8.png" width="1116" height="198" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-71911977dbbb25071d1f5937912cb91f"><amp-img class="size-full wp-image-6770  amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-8.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-8.png 1116w, /wp-content/uploads/2018/06/pentesting-ntfs-8-300x53.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-8-1024x182.png 1024w, /wp-content/uploads/2018/06/pentesting-ntfs-8-300x53@2x.png 600w" alt="" width="1116" height="198" layout="intrinsic"></amp-img></figure></p><p>You can try to enter the folder as often as you want, you will not see the files in the folder in the GUI. It’s also not possible to open the folder by passing “C:\test\…\…\” in the path input field in the above image.</p><p>(Side note: If you try to delete this folder from the GUI, explorer.exe will crash; You will see a dialog where windows is counting files in the folder and where it counts “a lot of files”; Maybe it’s better if you don’t try this on your working system…).</p><p>Searching for files in this folder via the GUI (explorer.exe) also doesn’t work, for example, if you search for the “123.txt” file with the GUI it will hang/search forever, without actually finding the files.</p><p>Please note that searching via cmd works without a problem:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-9.png" width="409" height="333" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-2dea000bb738a8c6fa4924f9e6a686a7"><amp-img class="wp-image-6771 size-full amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-9.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-9.png 409w, /wp-content/uploads/2018/06/pentesting-ntfs-9-300x244.png 300w" alt="" width="409" height="333" layout="intrinsic"></amp-img></figure></p><p>However, most people nowadays use Powershell and with Powershell you again can’t find the file because it will be stuck in an endless loop:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-10.png" width="430" height="276" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-9fd1aac1623b40483103f6b1f57086da"><amp-img class="wp-image-6772 size-full amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-10.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-10.png 430w, /wp-content/uploads/2018/06/pentesting-ntfs-10-300x193.png 300w" alt="" width="430" height="276" layout="intrinsic"></amp-img></figure></p><p>(Output is truncated because the command will print the two directories forever…).</p><p>A search for “123.txt” (E.g.: with “Get-ChildItem -Path C:\test -Filter 123.txt -Recurse -ErrorAction SilentlyContinue -Force”) will therefore never find the file (and will never end).</p><p>I also tested this with different AntiVirus products, these seem to work correctly (I placed malware samples in this directory and the tested AntiVirus solutions found them). Some of them were still confused by the path, e.g.: when searching for viruses inside “C:\test\…\” they searched in “C:\test\” instead. Also python code with os.walk() seems to work correctly.</p><p>Please note that just creating a directory junction which points to it’s own parent folder doesn’t lead to an endless loop in cmd or Powershell.</p><p> </p><h2><strong>TRICK 4: “HIDE” THE DESTINATION OF A DIRECTORY JUNCTION</strong></h2><p>Directory junctions are a very useful NTFS feature to find security vulnerabilities for attackers. Using it you can create (with normal user privileges) a symbolic link to a destination folder.</p><p>The best security vulnerability to explain directory junctions is in my opinion AVGater, where the attacker places a file in folder x. Then he marks the file as a virus and the installed AntiVirus solution will move it into the quarantine. After that the attacker removes the folder x and replaces it with a directory junction named “x” which points to C:\windows\System32\. If the attacker now clicks on the “restore” button the AntiVirus solution will copy the file to the x folder which now points to system32 with SYSTEM privileges (which directly leads to EoP).</p><p>Directory junctions can often be abused if the targeted application contains race condition vulnerabilities (TOCTOU vulnerabilities – time of check time of use).</p><p>A directory junction can be created with the mklink utility together with the /J argument. It’s possible to combine this with the ::$INDEX_ALLOCATION trick to create a directory junction with the name “…”:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-12.png" width="825" height="436" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6773 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-12.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-12.png 825w, /wp-content/uploads/2018/06/pentesting-ntfs-12-300x159.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-12-300x159@2x.png 600w" alt="" width="600" height="317" layout="intrinsic"></amp-img></figure></p><p>The first directory junction “test1” was created with a normal name and therefore the destination is correctly shown in the “dir” output. However, in the case of the “…” directory junction, the target is no longer displayed (instead […] is shown; see the red box). Please also note that you can let junction1 point to junction2 which points to junction3 and so on until the last one points to the actual destination.</p><p>Since the paths are confused, you can enter the junction with the above mentioned “cd …\…\” trick (to be in the system32 folder), but “.” will point to “C:\test8” instead:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-13.png" width="671" height="336" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6774 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-13.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-13.png 671w, /wp-content/uploads/2018/06/pentesting-ntfs-13-300x150.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-13-300x150@2x.png 600w" alt="" width="450" height="225" layout="intrinsic"></amp-img></figure></p><p>The dir command prints files from the system32 folder (red marked; please also note that the first command created the hello.bat file in C:\test8\).</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-14.png" width="592" height="241" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6775 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-14.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-14.png 592w, /wp-content/uploads/2018/06/pentesting-ntfs-14-300x122.png 300w" alt="" width="450" height="183" layout="intrinsic"></amp-img></figure></p><p>The red marked files are the last files from the system32 folder (last output of the dir command). In blue we can see that “hello.bat” from the current directory (“.\”) should be executed. Since the paths are confused, this will execute C:\test8\hello.bat (green box) and not C:\windows\system32\hello.bat. I’m not sure if this has a direct impact on the security since you can start files in any folder anyway, however, it could maybe be used to bypass application whitelisting solutions with whitelisted script files.</p><h2><strong>TRICK 5: HIDE ALTERNATE DATA STREAMS</strong></h2><p>As already discussed it’s possible to dump ADS via the /r switch in the dir command. Moreover, streams.exe is a tool from Sysinternals which can also dump the streams:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-30.png" width="643" height="590" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6782 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-30.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-30.png 643w, /wp-content/uploads/2018/06/pentesting-ntfs-30-300x275.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-30-300x275@2x.png 600w" alt="" width="450" height="413" layout="intrinsic"></amp-img></figure></p><p>On older versions of Windows it was possible to hide the ADS by using reserved names as base name (e.g.: CON, NUL, COM1, COM2, LPT1, …). However, on Windows 10 this seems to be fixed and is no longer possible, but “…” still works:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-31.png" width="625" height="799" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6783 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-31.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-31.png 625w, /wp-content/uploads/2018/06/pentesting-ntfs-31-235x300.png 235w, /wp-content/uploads/2018/06/pentesting-ntfs-31-235x300@2x.png 470w" alt="" width="450" height="575" layout="intrinsic"></amp-img></figure></p><p>The ADS on “…” was successfully created, but isn’t listed by the tools. Creating an ADS on COM1 results in an error, the creation of an ADS on NUL doesn’t have any affect (ADS will not be created).</p><p>Please note that you can also create an ADS on the drive like “echo 123 &gt; C:\:abc.txt”. This will hide from the “dir /r” command inside C:\. However, it will show the ADS inside subfolders of C:\ for the “..” directory. For example:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-32.png" width="623" height="518" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6784 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-32.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-32.png 623w, /wp-content/uploads/2018/06/pentesting-ntfs-32-300x249.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-32-300x249@2x.png 600w" alt="" width="450" height="374" layout="intrinsic"></amp-img></figure></p><p>The red marked ADS was created by the C:\:abc.txt ADS. This ADS is also visible via Sysinternals tool streams.exe if it’s called directly on C:\. Therefore, to hide from both tools the “…” trick should be used.</p><p>There exists a second trick which can be used to hide from the tools. On Windows you can add “.&lt;spaces&gt;.” at the end of a file and Windows will automatically remove it (canonicalization removes it).</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-40.png" width="565" height="318" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6786 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-40.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-40.png 565w, /wp-content/uploads/2018/06/pentesting-ntfs-40-300x169.png 300w" alt="" width="450" height="253" layout="intrinsic"></amp-img></figure></p><p>However, we can create such a file with an ADS! The funny property of such a file is that tools will not be able to open the file, because a path like “xyz. .” will automatically be changed to “xyz” and this file doesn’t exist.</p><p>Here is the proof:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-41.png" width="594" height="345" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6787 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-41.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-41.png 594w, /wp-content/uploads/2018/06/pentesting-ntfs-41-300x174.png 300w" alt="" width="450" height="261" layout="intrinsic"></amp-img></figure></p><p>The created ADS foobar.txt can’t be found by the tools:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-42.png" width="622" height="775" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6788 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-42.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-42.png 622w, /wp-content/uploads/2018/06/pentesting-ntfs-42-241x300.png 241w, /wp-content/uploads/2018/06/pentesting-ntfs-42-241x300@2x.png 482w" alt="" width="450" height="561" layout="intrinsic"></amp-img></figure></p><p>Side note 1: Such files can also be created via: echo test &gt; “test. .::$DATA”</p><p>Side note 2: Please note that the “..:abc.txt” ADS is the ADS which was created on “C:\:abc.txt”.</p><p>We can also create a directory with the name “. .” like this:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-50.png" width="559" height="348" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6789 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-50.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-50.png 559w, /wp-content/uploads/2018/06/pentesting-ntfs-50-300x187.png 300w" alt="" width="450" height="280" layout="intrinsic"></amp-img></figure></p><p>Then it’s not possible to enter this folder:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-51.png" width="696" height="263" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-9bafa402f4f82e00431e970948b4d179"><amp-img class="size-full wp-image-6790  amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-51.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-51.png 696w, /wp-content/uploads/2018/06/pentesting-ntfs-51-300x113.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-51-300x113@2x.png 600w" alt="" width="696" height="263" layout="intrinsic"></amp-img></figure></p><p>Moreover, the already mentioned technique (like cd . .\. .\ doesn’t work), but cd “. .::$INDEX_ALLOCATION” works (the double quotes are important).</p><p>If we can add spaces in between of a directory name, we can also add it at the end like “b ” or “.. ” or “. “.</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-52.png" width="620" height="499" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6791 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-52.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-52.png 620w, /wp-content/uploads/2018/06/pentesting-ntfs-52-300x241.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-52-300x241@2x.png 600w" alt="" width="450" height="362" layout="intrinsic"></amp-img></figure></p><p>Explanation: There is a “b” and a “b ” folder, a file named “a” and a file named “a “, the two default dirs “.” and “..” plus the “. ” and “.. ” ones and the “. .” dir.</p><p>Directories with the name “.. ” can be entered with our already discussed technique:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-53.png" width="797" height="472" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6792 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-53.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-53.png 797w, /wp-content/uploads/2018/06/pentesting-ntfs-53-300x178.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-53-300x178@2x.png 600w" alt="" width="450" height="266" layout="intrinsic"></amp-img></figure></p><p>Side note 1: This folder can be opened via the GUI if you click twice on the folder, also the content of the folder will be displayed correctly. However, files in it can’t be opened because of the wrong path (explorer.exe uses C:\test22\.. \.. \123.txt instead of C:\test22\.. \123.txt). Powershell will again be stuck in an endless loop when searching such folders.</p><p>Side note 2: You can also create an ADS on a folder with a name such as “abc”. Then you can rename the folder to a name just containing numbers (e.g. “1”). After that you can still see the ADS, but you can’t open it (ADS on a folder with a number as name doesn’t work). To open the ADS data you have to rename the folder first back to for example “abc”.</p><h2><strong>FILESYSTEM TRICKS VS. ANTIVIRUS PRODUCTS / FORENSIC SOFTWARE:</strong></h2><p>I did a quick verification of the above mentioned tricks against AntiVirus products to verify if these can catch malware which abuses the tricks. The most noteworthy finding was with files / folders ending with “. .”. For example, I stored the eicar test virus in a folder and copied it with the following commands:</p><pre>copy eicar.com &gt; "123. .::$DATA"
copy eicar.com &gt; tester 
echo 123 &gt; "foo. .::INDEX_ALLOCATION" 
cd "foo. .::$INDEX_ALLOCATION" 
copy ..\eicar.com . 
copy ..\eicar.com .\eicar</pre><p>After that I re-enabled the AntiVirus solutions and scanned the folder. All AntiVirus solutions just identified “eicar.com” and “tester” in this folder, but not the eicar virus in “123. .” or in the two files in the “foo. .” folder. However, when this folder is entered and the files are started, the AntiVirus products found them (because the content is loaded from the file system to memory). The “remove” action from Windows Defender could not remove the files and has therefore no impact, however, the “remove” action from for example Emsisoft could remove the test virus in the folder. Emsisoft just removed the “eicar.com” file in the “foo. .” folder, the “eicar” file was not removed and the content can be read without a problem (Emsisoft responded to us that only files which are mapped as executable are scanned with the exception of some specific file extensions like .com. This behavior can be altered in the file guard settings by switching to “Thorough” to also scan at file reads; Windows Defender on the other hand also blocked reading the “eicar” text file).</p><p>I also conducted a short test against Autopsy 4.6.0 (a free forensic software) by loading “logical files” into the tool (from the running system; not a disk image). The “…” folder can be entered, however, the “foo. .” folder can’t. Moreover, I created a file named “valid” with the content “valid” and a file called “valid. .” with the content “secret”. Autopsy shows for both files the content “valid” (and never the “secret” content). In addition to that, the “.. ” folder (with a space at the end) is intepreted as “..” and therefore goes one directory up at double click. This only applies to the “logical files” mode, in disk image (raw) mode, everything is displayed correctly (in the live mode Autopsy is using the Windows API to access the data and therefore problems occur).</p><h2><strong>TRICK 6: HIDING THE PROCESS BINARY</strong></h2><p>As already discussed above: Windows automatically removes “. .” at the end of a file. What if we can somehow start a process with a name like “file1. .”? Well, then it can happen that checks (e.g.: signature checks from AntiVirus products) are maybe performed on “file1” instead. Let’s try this:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new1.png" width="582" height="431" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6794 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new1.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new1.png 582w, /wp-content/uploads/2018/06/pentesting-ntfs-new1-300x222.png 300w" alt="" width="450" height="333" layout="intrinsic"></amp-img></figure></p><p>We created 3 files:</p><ul>
<li>“file” with the Microsoft signature from taskmgr</li>
<li>“file. .” which is our “fake malware” which should be hidden but executed</li>
<li>“filex x” which contains the signature from WinSCP. This file will become important later.</li>
</ul>
<p>We now need a way to start a process from the “file. .” binary which is not a trivial task because all Microsoft Windows API calls automatically remove the “. .” from the filename and would start “file” (taskmgr) instead. To deal with this problem we use the following code:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new2.png" width="1078" height="426" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6795 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new2.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new2.png 1078w, /wp-content/uploads/2018/06/pentesting-ntfs-new2-300x119.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new2-1024x405.png 1024w, /wp-content/uploads/2018/06/pentesting-ntfs-new2-300x119@2x.png 600w" alt="" width="450" height="178" layout="intrinsic"></amp-img></figure></p><p>The above code just calls CreateProcessA to create a process from “filex x” (WinSCP). If we compile this application and start it, WinSCP will be started. However, we are not going to start it normally. Instead, we start the application inside a debugger (e.g.: WinDbg). Now we set a breakpoint at the function which makes the associated system call: “bp ntdll!NtCreateUserProcess”. With “g” (go) we can start our program in the debugger and hit the breakpoint. At the breakpoint the current stack can be dumped (“dq rsp”). The 12th pointer on the stack is important and should be dumped. The 4th value at this address is the pointer to our file name.</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new3.png" width="859" height="318" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6796 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new3.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new3.png 859w, /wp-content/uploads/2018/06/pentesting-ntfs-new3-300x111.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new3-300x111@2x.png 600w" alt="" width="600" height="222" layout="intrinsic"></amp-img></figure></p><p>The filename (green box) is now normalized (it starts with \??\C:\…). Exactly this normalization would had also remove the “. .” from the end of the filename – that’s why the above C-code didn’t use “file. .” as process name. However, since normalization already happend, this value can now be modified. Let’s overwrite the “x” characters with “.” (command “eb” for edit bytes):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new4.png" width="825" height="251" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6797 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new4.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new4.png 825w, /wp-content/uploads/2018/06/pentesting-ntfs-new4-300x91.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new4-300x91@2x.png 600w" alt="" width="600" height="183" layout="intrinsic"></amp-img></figure></p><p>After that just continue execution with “g”. Guess what will happen?</p><p>Correct, “file. .” (the malware) gets executed. However, if a user right clicks the process in the task manager and selects “properties” the properties of “file” (taskmgr) with the valid Microsoft signature will be shown.</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new5.png" width="512" height="347" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-c69912b7ce5f76d49ca2f88ba9fcb2df"><amp-img class="wp-image-6798 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new5.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new5.png 512w, /wp-content/uploads/2018/06/pentesting-ntfs-new5-300x203.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new5-400x270.png 400w, /wp-content/uploads/2018/06/pentesting-ntfs-new5-500x340.png 500w" alt="" width="450" height="305" layout="intrinsic"></amp-img></figure></p><p>But what is with “filex x” (WinSCP)? Yes, this file gets also shown as the running process namely in process explorer (because the path was set before NtCreateUserProcess was called):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new6.png" width="1011" height="407" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6799 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new6.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new6.png 1011w, /wp-content/uploads/2018/06/pentesting-ntfs-new6-300x121.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new6-300x121@2x.png 600w" alt="" width="600" height="242" layout="intrinsic"></amp-img></figure></p><p>And what is with powershell? Yes, also the wrong binary:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new7.png" width="1087" height="123" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-5c2ffdd18592dbc587ec3184c4bd0d75"><amp-img class="size-full wp-image-6800  amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-new7.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-new7.png 1087w, /wp-content/uploads/2018/06/pentesting-ntfs-new7-300x34.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-new7-1024x116.png 1024w, /wp-content/uploads/2018/06/pentesting-ntfs-new7-300x34@2x.png 600w" alt="" width="1087" height="123" layout="intrinsic"></amp-img></figure></p><p>Is this a problem? Well, it depends. First of all, an attacker can start a process (the malware), rename / remove it afterwards and then rename a valid file to the same name. Then the above effects in taskmanager and process explorer will also occur. However, the difference is that with the above mentioned trick this happens exactly at the same time when the process gets launched.</p><p>For example, consider that the installed endpoint protection checks for every started process if the binary hash is already known in the cloud. With this trick the endpoint protection may use the wrong binary to verify if the hash is already known. Please also note that a debugger is not required to create such processes. An application can just hook the NtCreateUserProcess function and implement the modifications in the hook.</p><h2><strong>WINDOWS CMD TRICKS:</strong></h2><p>These tricks have nothing to do with file system tricks, however, I think they fit well in this blog post. In the Windows cmd it’s possible to write ^ at any location in the command and cmd will completely ignore it. For example, “calc.exe” is the same as “ca^l^c”. It’s just important that ^ is not the last symbol and that two ^ symbols are not used after each other. Instead of ^ the double quote can also be used and this has no restrictions (it can be the last character or used multiple times). For example, ^ca^”^”^lc^” will start the calculator.</p><p>The same applies to zero-length environment variables. An environment variable can be accessed via %name%. If the environment variable has a length of zero, “cal%name%c” would be the same as “calc”. Since environment variables don’t have per default a length of zero, this can’t be used directly. However, it’s possible to call substring on the environment variable with a special syntax (:~start,end). The following figure shows the “windir” environment variable and how substring can be used with negativ values to get a zero-length variable returned:</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-25.png" width="437" height="334" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><figure class="aligncenter amp-wp-inline-1ba349842782125155a70159a7111420"><amp-img class="wp-image-6781 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-25.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-25.png 437w, /wp-content/uploads/2018/06/pentesting-ntfs-25-300x229.png 300w" alt="" width="351" height="268" layout="intrinsic"></amp-img></figure></p><p>The following figure shows a combination of these techniques to hide that Powershell is started in version 2 (which was a long time helpful but should not be done anymore on latest Windows 10):</p><p><amp-img src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-22.png" width="962" height="169" class="amp-wp-enforced-sizes" layout="intrinsic"></amp-img></p><p><u><strong><figure class="aligncenter amp-wp-inline-e407ac51e00eb7ad9e758d070160c9d8"><amp-img class="wp-image-6778 amp-wp-enforced-sizes" src="https://sec-consult.com/wp-content/uploads/2018/06/pentesting-ntfs-22.png" srcset="/wp-content/uploads/2018/06/pentesting-ntfs-22.png 962w, /wp-content/uploads/2018/06/pentesting-ntfs-22-300x53.png 300w, /wp-content/uploads/2018/06/pentesting-ntfs-22-300x53@2x.png 600w" alt="" width="600" height="105" layout="intrinsic"></amp-img></figure></strong></u></p><p>You can see the use of ^ and the environment variable trick (%os:~0,-56%), but also that the version “00000000002.0000” (instead of just 2) is used and that the argument is “?ver” and not “-ver” (note, this is not a normal ? symbol, it’s U+2015; just using ? would not work).</p><p>On Windows “/” can also be used in paths instead of “\”. For example, C:\Windows/\//\system32\calc.exe is the same as C:\Windows\system32\calc.exe. Moreover, you can also access the binary via the UNC path to avoide the “C:\” pattern: \\127.0.0.1\C$\windows\system32\calc.exe</p><p>Similiar tricks can often be used to defeat blacklist approaches (e.g. if powershell.exe is forbidden, an attacker can call power^shell.exe to bypass the restriction. Or if calc is forbidden, you can execute:</p><p>^”%Localappdata:~-3%^%SystemRoot:~0,1%^”</p><p>to start calc.exe and so on).</p><h2><strong>REFERENCES:</strong></h2><p><a href="https://msdn.microsoft.com/en-us/library/dn393272.aspx">https://msdn.microsoft.com/en-us/library/dn393272.aspx</a></p><p><a href="https://tyranidslair.blogspot.co.at/2014/05/abusive-directory-syndrome.html">https://tyranidslair.blogspot.co.at/2014/05/abusive-directory-syndrome.html</a></p><p><a href="https://tyranidslair.blogspot.co.at/2014/06/addictive-double-quoting-sickness.html">https://tyranidslair.blogspot.co.at/2014/06/addictive-double-quoting-sickness.html</a></p><p><a href="https://googleprojectzero.blogspot.co.at/2016/02/the-definitive-guide-on-win32-to-nt.html">https://googleprojectzero.blogspot.co.at/2016/02/the-definitive-guide-on-win32-to-nt.html</a></p><p><a href="https://googleprojectzero.blogspot.co.at/2015/12/between-rock-and-hard-link.html">https://googleprojectzero.blogspot.co.at/2015/12/between-rock-and-hard-link.html</a></p><p><a href="https://googleprojectzero.blogspot.co.at/2015/08/windows-10hh-symbolic-link-mitigations.html">https://googleprojectzero.blogspot.co.at/2015/08/windows-10hh-symbolic-link-mitigations.html</a></p><p><a href="http://insert-script.blogspot.co.at/2012/11/hidden-alternative-data-streams.html">http://insert-script.blogspot.co.at/2012/11/hidden-alternative-data-streams.html</a></p><p><a href="https://bogner.sh/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/">https://bogner.sh/2017/11/avgater-getting-local-admin-by-abusing-the-anti-virus-quarantine/</a></p>	</div>

	<footer class="amp-wp-article-footer">
			<div class="amp-wp-meta amp-wp-tax-category">
		Categories: <a href="https://movaxbx.ru/category/bypassing/" rel="category tag">Bypassing</a>, <a href="https://movaxbx.ru/category/ntfs/" rel="category tag">ntfs</a>, <a href="https://movaxbx.ru/category/tricks/" rel="category tag">tricks</a>, <a href="https://movaxbx.ru/category/windows/" rel="category tag">windows</a>	</div>

	<div class="amp-wp-meta amp-wp-tax-tag">
		Tags: <a href="https://movaxbx.ru/tag/bypass/" rel="tag">bypass</a>, <a href="https://movaxbx.ru/tag/ntfs/" rel="tag">ntfs</a>, <a href="https://movaxbx.ru/tag/tricks/" rel="tag">Tricks</a>, <a href="https://movaxbx.ru/tag/windows/" rel="tag">Windows</a>	</div>
		<div class="amp-wp-meta amp-wp-comments-link">
		<a href="../index.html#comments">
			Leave a Comment		</a>
	</div>
	</footer>
</article>

<footer class="amp-wp-footer">
	<div>
		<h2>MOV AX, BX</h2>
		<p>
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
		</p>
		<a href="#top" class="back-to-top">Back to top</a>
	</div>
</footer>


	<amp-pixel src="https://pixel.wp.com/g.gif?v=ext&amp;j=1%3A6.2.1&amp;blog=146963816&amp;post=529&amp;tz=3&amp;srv=movaxbx.ru&amp;host=movaxbx.ru&amp;rand=RANDOM&amp;ref=DOCUMENT_REFERRER"></amp-pixel>
	
</body>

<!-- Mirrored from movaxbx.ru/2018/06/13/windows-ntfs-tricks-collection/amp/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 14 Jun 2018 09:19:48 GMT -->
</html>
